<app-loading-wrapper>
  @if (usuario$ | async; as usuario) {
  <div class="h-full w-full p-1">
    <div
      class="h-full w-full overflow-auto rounded-2xl border border-white bg-crema p-6 shadow-inner"
    >
      <div class="mb-6 flex items-center justify-between">
        <h1 class="text-4xl font-bold text-azul-oscuro">
          {{ 'perfilPaciente.titulo' | transloco }}
        </h1>
        <button
          (click)="abrirModalDescarga()"
          class="hover:bg-azul rounded-lg bg-azul-oscuro px-6 py-3 font-semibold text-white shadow-lg transition-all hover:scale-105"
        >
          ðŸ“„ {{ 'perfilPaciente.descargarHistoria' | transloco }}
        </button>
      </div>
      <div class="mb-6 flex items-center">
        <img
          [src]="usuario.urlImagenFondo || 'assets/imagenes/banerWelcomePage.webp'"
          alt="Portada"
          class="h-70 w-full rounded-2xl object-cover"
          appTrackImage
        />
      </div>
      <div class="mb-8 flex items-center gap-8 pt-10 pl-10">
        <img
          [src]="usuario.urlImagenPerfil || 'assets/imagenes/logo.svg'"
          alt="Avatar"
          class="h-42 w-42 rounded-full border-4 border-white object-cover shadow-md"
          appTrackImage
        />
        <div
          class="grid grid-cols-2 gap-x-1 gap-y-1 text-xl font-normal text-gray-700"
          style="min-width: 300px"
        >
          <p>
            <strong>{{ 'perfilPaciente.nombre' | transloco }}</strong> {{
            usuario.nombre }}
          </p>
          <p>
            <strong>{{ 'perfilPaciente.apellido' | transloco }}</strong> {{
            usuario.apellido }}
          </p>
          <p>
            <strong>{{ 'perfilPaciente.edad' | transloco }}</strong> {{
            usuario.edad }}
          </p>
          <p>
            <strong>{{ 'perfilPaciente.dni' | transloco }}</strong> {{
            usuario.dni }}
          </p>
          <p>
            <strong>{{ 'perfilPaciente.obraSocial' | transloco }}</strong> {{
            usuario.obraSocial || ('perfilPaciente.noRegistrada' | transloco) }}
          </p>
          <p>
            <strong>{{ 'perfilPaciente.email' | transloco }}</strong> {{
            usuario.email }}
          </p>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Modal de selecciÃ³n de descarga -->
  @if (mostrarModalDescarga) {
  <div
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"
    role="dialog"
    aria-modal="true"
    tabindex="-1"
    (click)="cerrarModalDescarga()"
    (keydown.escape)="cerrarModalDescarga()"
  >
    <div
      class="w-full max-w-lg rounded-xl bg-white p-8 shadow-2xl"
      role="document"
      (click)="$event.stopPropagation()"
      (keydown)="$event.stopPropagation()"
    >
      <h2 class="mb-6 text-2xl font-bold text-azul-oscuro">
        {{ 'perfilPaciente.modal.titulo' | transloco }}
      </h2>

      <p class="mb-4 text-gray-600">
        {{ 'perfilPaciente.modal.descripcion' | transloco }}
      </p>

      <!-- OpciÃ³n: Todo el historial -->
      <div
        role="button"
        tabindex="0"
        (click)="seleccionarEspecialidad(null)"
        (keydown.enter)="seleccionarEspecialidad(null)"
        (keydown.space)="seleccionarEspecialidad(null); $event.preventDefault()"
        [class.border-azul]="especialidadSeleccionada === null"
        [class.bg-azul-claro]="especialidadSeleccionada === null"
        class="hover:border-azul mb-3 cursor-pointer rounded-lg border-2 border-gray-300 p-4 transition-all hover:bg-azul-claro"
      >
        <div class="flex items-center">
          <input
            type="radio"
            name="especialidad"
            [checked]="especialidadSeleccionada === null"
            class="mr-3 h-5 w-5"
          />
          <div>
            <p class="font-semibold text-azul-oscuro">
              {{ 'perfilPaciente.modal.historiaCompleta' | transloco }}
            </p>
            <p class="text-sm text-gray-600">
              {{ 'perfilPaciente.modal.todasEspecialidades' | transloco: {
              count: citas.length } }}
            </p>
          </div>
        </div>
      </div>

      <!-- Opciones por especialidad -->
      @if (especialidades.length > 0) {
      <p class="mt-4 mb-2 text-sm font-semibold text-gray-700">
        {{ 'perfilPaciente.modal.filtrarPorEspecialidad' | transloco }}
      </p>
      } @for (especialidad of especialidades; track especialidad) {
      <div
        role="button"
        tabindex="0"
        (click)="seleccionarEspecialidad(especialidad)"
        (keydown.enter)="seleccionarEspecialidad(especialidad)"
        (keydown.space)="seleccionarEspecialidad(especialidad); $event.preventDefault()"
        [class.border-azul]="especialidadSeleccionada === especialidad"
        [class.bg-azul-claro]="especialidadSeleccionada === especialidad"
        class="hover:border-azul mb-3 cursor-pointer rounded-lg border-2 border-gray-300 p-4 transition-all hover:bg-azul-claro"
      >
        <div class="flex items-center">
          <input
            type="radio"
            name="especialidad"
            [checked]="especialidadSeleccionada === especialidad"
            class="mr-3 h-5 w-5"
          />
          <div>
            <p class="font-semibold text-azul-oscuro">{{ especialidad }}</p>
            <p class="text-sm text-gray-600">
              {{ 'perfilPaciente.modal.consultasCount' | transloco: { count:
              contarCitasPorEspecialidad(especialidad) } }}
            </p>
          </div>
        </div>
      </div>
      }

      <!-- Botones de acciÃ³n -->
      <div class="mt-6 flex gap-3">
        <button
          (click)="cerrarModalDescarga()"
          class="flex-1 rounded-lg border-2 border-gray-300 bg-white px-4 py-3 font-semibold text-gray-700 transition-all hover:scale-105 hover:border-gray-400 hover:bg-gray-100 hover:shadow-md active:scale-95"
        >
          {{ 'perfilPaciente.modal.cancelar' | transloco }}
        </button>
        <button
          (click)="descargarHistoriaClinica()"
          [disabled]="especialidadSeleccionada === undefined"
          class="hover:bg-azul flex-1 rounded-lg bg-azul-oscuro px-4 py-3 font-semibold text-white shadow-md transition-all hover:scale-105 hover:shadow-xl active:scale-95 disabled:cursor-not-allowed disabled:bg-gray-400 disabled:hover:scale-100"
        >
          {{ 'perfilPaciente.modal.descargarPdf' | transloco }}
        </button>
      </div>
    </div>
  </div>
  }
</app-loading-wrapper>
