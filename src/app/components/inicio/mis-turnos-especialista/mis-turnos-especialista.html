<div class="h-full w-full p-1">
  <div
    class="h-full w-full overflow-auto rounded-2xl border border-white bg-[color:var(--color-crema)] p-6 shadow-inner"
  >
    <div class="mb-4 flex flex-wrap items-center gap-3">
      <label
        for="filtro"
        class="text-sm font-semibold text-[color:var(--color-azul-oscuro)]"
      >
        Filtrar:
      </label>

      <input
        id="filtro"
        type="text"
        [(ngModel)]="filtroValorModel"
        placeholder="Ingres√° filtro"
        class="w-64 rounded border border-gray-300 px-3 py-1 text-sm focus:ring-2 focus:ring-[color:var(--color-azul-oscuro)] focus:outline-none"
      />

      <button
        type="button"
        (click)="limpiarFiltro()"
        class="mr-6 rounded bg-[color:var(--color-azul-oscuro)] px-3 py-1 text-sm font-semibold text-white shadow transition-transform hover:scale-105 hover:bg-[color:var(--color-azul-claro)]"
      >
        Limpiar Filtros
      </button>

      <button
        type="button"
        (click)="ordenarPorFecha()"
        [class.bg-green-600]="ordenamiento() === 'fecha'"
        [class.bg-green-800]="ordenamiento() !== 'fecha'"
        class="rounded px-3 py-1 text-sm font-semibold text-white shadow transition-transform hover:scale-105"
      >
        üìÖ Ordenar por Fecha
      </button>

      <button
        type="button"
        (click)="ordenarPorEstado()"
        [class.bg-purple-600]="ordenamiento() === 'estado'"
        [class.bg-purple-800]="ordenamiento() !== 'estado'"
        class="rounded px-3 py-1 text-sm font-semibold text-white shadow transition-transform hover:scale-105"
      >
        üè∑Ô∏è Ordenar por Estado
      </button>

      <div class="ml-auto">
        @if (mostrarPopupAcciones && citaSeleccionada()) {
        <app-acciones-especialista
          [cita]="citaSeleccionada()!"
          (cerrar)="cerrarPopupAcciones()"
          (accionRealizada)="accionDesdeModal()"
        ></app-acciones-especialista>
        }
      </div>
    </div>

    <table class="min-w-full border-collapse border border-gray-300 text-sm">
      <thead>
        <tr
          class="bg-[color:var(--color-azul-claro)] text-[color:var(--color-azul-oscuro)]"
        >
          @for (col of columnasConDatosDinamicos; track col) {
          <th class="border border-gray-300 px-3 py-2">{{ col.label }}</th>
          }
        </tr>
      </thead>

      <tbody>
        @if (!cargando()) { @for (cita of citasFiltradas; track cita) {
        <tr
          class="cursor-pointer border border-gray-300 transition-colors duration-150 hover:bg-[color:var(--color-verde-claro)]"
          (click)="toggleFilaExpandida(cita.citaId)"
          [style.background-color]="
                filaExpandida() === cita.citaId ? 'rgba(46, 64, 45, 0.2)' : null
              "
        >
          <td class="border border-gray-300 px-3 py-1">{{ cita.citaId }}</td>
          <td class="border border-gray-300 px-3 py-1">
            {{ cita.fechaHora | date : 'short' }}
          </td>
          <td
            class="rounded border border-gray-300 px-3 py-1 text-center font-semibold"
            [appColorEstado]="cita.estado"
          >
            {{ cita.estado | titlecase }}
          </td>
          <td class="border border-gray-300 px-3 py-1">
            {{ cita.alturaCm | unidadMedida:'altura' }}
          </td>
          <td class="border border-gray-300 px-3 py-1">
            {{ cita.pesoKg | unidadMedida:'peso' }}
          </td>
          <td class="border border-gray-300 px-3 py-1">
            {{ cita.temperaturaC | unidadMedida:'temperatura' }}
          </td>
          <td class="border border-gray-300 px-3 py-1">
            {{ cita.presionArterial | unidadMedida:'presion' }}
          </td>
          <td class="border border-gray-300 px-3 py-1">
            {{ cita.pacienteNombreCompleto }}
          </td>
          <td class="border border-gray-300 px-3 py-1">
            {{ cita.especialistaNombreCompleto }}
          </td>
          <td class="border border-gray-300 px-3 py-1">
            {{ cita.especialidadNombre }}
          </td>
          <td class="border border-gray-300 px-3 py-1 text-center">
            <button
              class="text-[color:var(--color-azul-oscuro)] underline hover:text-[color:var(--color-azul-claro)]"
              type="button"
            >
              {{ filaExpandida() === cita.citaId ? 'Ocultar' : 'Mostrar' }}
            </button>
          </td>
          <td
            class="border border-gray-300 bg-green-200 px-3 py-1 text-center hover:bg-green-500"
          >
            <button
              class="font-bold text-[color:var(--color-azul-oscuro)] hover:text-[color:var(--color-white)]"
              type="button"
              (click)="abrirPopupAcciones(cita)"
            >
              Acciones
            </button>
          </td>
        </tr>
        @if (filaExpandida() === cita.citaId) {
        <tr>
          <td
            colspan="11"
            class="border border-gray-300 bg-[color:var(--color-crema)] px-3 py-2 text-[color:var(--color-azul-oscuro)]"
          >
            <div class="grid grid-cols-2 gap-4">
              @for (dato of cita.datosDinamicos; track dato) {
              <div><strong>{{ dato.clave }}:</strong> {{ dato.valor }}</div>
              }
            </div>
          </td>
        </tr>
        } } } @else {
        <tr>
          <td
            colspan="11"
            class="border border-gray-300 px-3 py-6 text-center font-semibold text-[color:var(--color-azul-oscuro)]"
          >
            Cargando datos...
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
</div>
