<!-- Modal Overlay -->
<div
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
  (click)="cerrarPopup()"
  (keyup.escape)="cerrarPopup()"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
>
  <!-- Modal Content -->
  <div
    class="w-full max-w-3xl rounded-2xl bg-white px-6 py-1 shadow-xl"
    (click)="$event.stopPropagation()"
    (keyup)="$event.stopPropagation()"
    tabindex="0"
  >
    <h2 class="mt-2 mb-4 text-center text-4xl font-bold text-azul-oscuro">
      Alta
    </h2>

    <!-- Selección de tipo de usuario -->
    @if (!tipoUsuario && registroForm) {
    <div class="space-y-6 p-10 text-center">
      <p class="text-xl text-gray-700">Seleccionar tipo usuario para alta</p>
      <div class="flex flex-col justify-center gap-6 sm:flex-row">
        <button
          (click)="seleccionarTipo('paciente')"
          class="rounded-xl bg-white px-8 py-4 shadow transition-transform hover:scale-105"
        >
          <span class="text-xl font-semibold text-azul-oscuro">Paciente</span>
        </button>
        <button
          (click)="seleccionarTipo('especialista')"
          class="rounded-xl bg-white px-8 py-4 shadow transition-transform hover:scale-105"
        >
          <span class="text-xl font-semibold text-azul-oscuro"
            >Especialista</span
          >
        </button>
        <button
          (click)="seleccionarTipo('admin')"
          class="rounded-xl bg-white px-8 py-4 shadow transition-transform hover:scale-105"
        >
          <span class="text-xl font-semibold text-azul-oscuro">Admin</span>
        </button>
      </div>
    </div>
    }

    <!-- Formulario -->
    @if (tipoUsuario && registroForm) {
    <form
      [formGroup]="registroForm"
      (ngSubmit)="registrar()"
      class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2"
    >
      <!-- Nombre -->
      <mat-form-field appearance="fill">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" />
        @if (registroForm.get('nombre')?.hasError('required')) {
        <mat-error> Campo obligatorio </mat-error>
        } @if (registroForm.get('nombre')?.hasError('minlength')) {
        <mat-error> Mínimo 2 caracteres </mat-error>
        } @if (registroForm.get('nombre')?.hasError('pattern')) {
        <mat-error> Solo letras </mat-error>
        }
      </mat-form-field>
      <!-- Apellido -->
      <mat-form-field appearance="fill">
        <mat-label>Apellido</mat-label>
        <input matInput formControlName="apellido" />
        @if (registroForm.get('apellido')?.hasError('required')) {
        <mat-error> Campo obligatorio </mat-error>
        } @if (registroForm.get('apellido')?.hasError('minlength')) {
        <mat-error> Mínimo 2 caracteres </mat-error>
        } @if (registroForm.get('apellido')?.hasError('pattern')) {
        <mat-error> Solo letras </mat-error>
        }
      </mat-form-field>
      <!-- Edad -->
      <mat-form-field appearance="fill">
        <mat-label>Edad</mat-label>
        <input matInput type="number" formControlName="edad" />
        @if (registroForm.get('edad')?.hasError('required')) {
        <mat-error> Campo obligatorio </mat-error>
        } @if (registroForm.get('edad')?.hasError('min')) {
        <mat-error> Mínimo 18 </mat-error>
        } @if (registroForm.get('edad')?.hasError('max')) {
        <mat-error> Máximo 99 </mat-error>
        }
      </mat-form-field>
      <!-- DNI -->
      <mat-form-field appearance="fill">
        <mat-label>DNI</mat-label>
        <input matInput formControlName="dni" />
        @if (registroForm.get('dni')?.hasError('required')) {
        <mat-error> Campo obligatorio </mat-error>
        } @if (registroForm.get('dni')?.hasError('pattern')) {
        <mat-error> Debe contener 8 dígitos </mat-error>
        }
      </mat-form-field>
      <!-- Obra Social -->
      @if (tipoUsuario === 'paciente') {
      <mat-form-field appearance="fill">
        <mat-label>Obra Social</mat-label>
        <mat-select formControlName="obraSocial">
          @for (obra of obraSocialOptions; track obra) {
          <mat-option [value]="obra"> {{ obra }} </mat-option>
          }
        </mat-select>
        @if (registroForm.get('obraSocial')?.hasError('required')) {
        <mat-error> Campo obligatorio </mat-error>
        }
      </mat-form-field>
      }
      <!-- Especialidades (Solo especialista) -->
      @if (tipoUsuario === 'especialista') {
      <div class="col-span-2">
        <div class="mb-1 text-sm font-medium text-azul-oscuro">
          Especialidades (seleccioná al menos una)
        </div>
        <div class="relative">
          <div
            class="flex min-h-[56px] cursor-pointer items-center rounded-md border border-gray-300 bg-white px-4 py-3 transition-colors hover:border-azul-oscuro"
            (click)="toggleDesplegableEspecialidades($event)"
            (keyup.enter)="toggleDesplegableEspecialidades($event)"
            (keyup.space)="toggleDesplegableEspecialidades($event)"
            tabindex="0"
            [class.border-azul-oscuro]="desplegableEspecialidadesAbierto"
          >
            <span class="flex-1 text-sm text-gray-700">
              {{ obtenerEspecialidadesSeleccionadasTexto() }}
            </span>
            <mat-icon class="text-gray-500"
              >{{ desplegableEspecialidadesAbierto ? "expand_less" :
              "expand_more" }}</mat-icon
            >
          </div>
          <!-- Desplegable con checkboxes -->
          @if (desplegableEspecialidadesAbierto) {
          <div
            class="absolute top-full right-0 left-0 z-10 mt-1 max-h-60 overflow-y-auto rounded-lg border border-gray-300 bg-white p-3 shadow-lg"
          >
            <div class="space-y-2">
              @for (especialidad of especialidadOptions; track especialidad) {
              <mat-checkbox
                [checked]="esEspecialidadSeleccionada(especialidad.id)"
                (change)="toggleEspecialidad(especialidad.id)"
                class="block text-sm"
              >
                {{ especialidad.nombre }}
              </mat-checkbox>
              }
            </div>
            <!-- Botón para agregar nueva especialidad -->
            <div class="mt-3 border-t pt-2">
              <button
                type="button"
                mat-button
                (click)="toggleMostrarNuevaEspecialidad(); $event.stopPropagation()"
                class="w-full text-left text-sm text-azul-oscuro"
              >
                {{ mostrarCampoOtraEspecialidad ? "✕ Cancelar" : "+ Agregar
                nueva especialidad" }}
              </button>
              <!-- Campo para nueva especialidad dentro del desplegable -->
              @if (mostrarCampoOtraEspecialidad) {
              <div class="mt-2">
                <input
                  formControlName="nuevaEspecialidad"
                  placeholder="Nombre de la especialidad"
                  class="w-full rounded border border-gray-300 px-3 py-2 text-sm focus:border-azul-oscuro focus:outline-none"
                  (click)="$event.stopPropagation()"
                />
                @if
                (registroForm.get('nuevaEspecialidad')?.hasError('minlength')) {
                <div class="mt-1 text-xs text-red-600">Mínimo 2 caracteres</div>
                } @if
                (registroForm.get('nuevaEspecialidad')?.hasError('pattern')) {
                <div class="mt-1 text-xs text-red-600">
                  Solo letras y espacios
                </div>
                }
              </div>
              }
            </div>
          </div>
          }
        </div>
        <!-- Error si no hay especialidades seleccionadas -->
        @if
        (registroForm.get('especialidadesSeleccionadas')?.hasError('alMenosUna')
        && registroForm.get('especialidadesSeleccionadas')?.touched) {
        <div class="mt-1 text-sm text-red-600">
          Debés seleccionar al menos una especialidad o agregar una nueva
        </div>
        }
      </div>
      }
      <!-- Email -->
      <mat-form-field appearance="fill">
        <mat-label>Email</mat-label>
        <input matInput type="email" formControlName="mail" />
        @if (registroForm.get('mail')?.hasError('required')) {
        <mat-error> Campo obligatorio </mat-error>
        } @if (registroForm.get('mail')?.hasError('email')) {
        <mat-error> Email inválido </mat-error>
        }
      </mat-form-field>
      <!-- Password -->
      <mat-form-field appearance="fill">
        <mat-label>Contraseña</mat-label>
        <input matInput type="password" formControlName="password" />
        @if (registroForm.get('password')?.hasError('required')) {
        <mat-error> Campo obligatorio </mat-error>
        } @if (registroForm.get('password')?.hasError('minlength')) {
        <mat-error> Mínimo 7 caracteres </mat-error>
        }
      </mat-form-field>
      <!-- Imagen Perfil -->
      <div class="md:col-span-2">
        <label
          for="imagenPerfilAdmin"
          class="block text-sm font-medium text-gray-700"
          >Imagen de perfil</label
        >
        <input
          id="imagenPerfilAdmin"
          type="file"
          (change)="onFileSelected($event, 'perfil')"
          accept="image/*"
          class="register-input"
        />
        @if (registroForm.get('imagenPerfil')?.hasError('required')) {
        <mat-error> Campo obligatorio </mat-error>
        }
      </div>
      <!-- Imagen Fondo -->
      @if (tipoUsuario === 'paciente') {
      <div class="md:col-span-2">
        <label
          for="imagenFondoAdmin"
          class="block text-sm font-medium text-gray-700"
          >Imagen de fondo</label
        >
        <input
          id="imagenFondoAdmin"
          type="file"
          (change)="onFileSelected($event, 'fondo')"
          accept="image/*"
          class="register-input"
        />
      </div>
      }

      <!-- Botón -->
      <div class="flex justify-center pt-2 md:col-span-2">
        <button
          mat-raised-button
          color="primary"
          class="rounded-full bg-verde-oscuro px-6 py-2 text-white shadow"
          [disabled]="registroForm.invalid"
          type="submit"
        >
          Registrar
        </button>
      </div>
      <!-- Cambiar tipo -->
      <div class="text-center md:col-span-2">
        <button
          mat-button
          type="button"
          (click)="tipoUsuario = null"
          class="text-sm text-gray-600 underline"
        >
          Cambiar tipo de usuario
        </button>
      </div>
    </form>
    }
  </div>
</div>
