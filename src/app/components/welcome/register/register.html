<div class="min-h-screen bg-gray-200 pt-30 pb-60">
  <h2 class="pb-1 text-center text-4xl font-bold text-azul-oscuro">Registro</h2>

  <!-- Selección de tipo de usuario -->
  @if (!tipoUsuario && registroForm) {
    <div class="pt-16 pb-30 text-center">
      <p class="mb-6 text-xl text-gray-700">¿Qué tipo de usuario sos?</p>
      <div class="flex flex-col items-center gap-6">
        <!-- Opción Paciente -->
        <div
          class="w-[380px] cursor-pointer p-2 transition-transform hover:scale-105"
          (click)="seleccionarTipo('paciente')"
          (keyup.enter)="seleccionarTipo('paciente')"
          (keyup.space)="seleccionarTipo('paciente')"
          tabindex="0"
          role="button"
          aria-label="Seleccionar tipo de usuario Paciente"
          >
          <div class="rounded-2xl bg-white shadow-lg">
            <img
              src="assets/imagenes/Registro/pacientes.jpg"
              alt="Paciente"
              class="h-55 w-full rounded-t-2xl object-cover"
              />
              <div class="p-4">
                <h3 class="text-xl font-bold text-azul-oscuro">Paciente</h3>
              </div>
            </div>
          </div>
          <!-- Opción Especialista -->
          <div
            class="w-[380px] cursor-pointer p-2 transition-transform hover:scale-105"
            (click)="seleccionarTipo('especialista')"
            (keyup.enter)="seleccionarTipo('especialista')"
            (keyup.space)="seleccionarTipo('especialista')"
            tabindex="0"
            role="button"
            aria-label="Seleccionar tipo de usuario Especialista"
            >
            <div class="rounded-2xl bg-white shadow-lg">
              <img
                src="assets/imagenes/Registro/especialistas.jpg"
                alt="Especialista"
                class="h-55 w-full rounded-t-2xl object-cover"
                />
                <div class="p-4">
                  <h3 class="text-xl font-bold text-azul-oscuro">Especialista</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
      }

      <!-- formulario -->
      @if (tipoUsuario && registroForm) {
        <div class="flex justify-center py-8">
          <form
            [formGroup]="registroForm"
            (ngSubmit)="registrar()"
            class="grid w-full max-w-2xl grid-cols-1 gap-4 rounded-xl bg-crema p-8 shadow-lg md:grid-cols-2"
            >
            <!-- Nombre -->
            <mat-form-field
              appearance="fill"
              class="col-span-1"
        [ngClass]="{
    'mat-form-field-valid': registroForm.get('nombre')?.valid && (registroForm.get('nombre')?.dirty || registroForm.get('nombre')?.touched),
    'mat-form-field-invalid': registroForm.get('nombre')?.invalid && (registroForm.get('nombre')?.dirty || registroForm.get('nombre')?.touched)
  }"
              >
              <mat-label>Nombre</mat-label>
              <input matInput formControlName="nombre" />
              @if (registroForm.get('nombre')?.hasError('required')) {
                <mat-error
                  >Campo obligatorio</mat-error
                  >
              }
              @if (registroForm.get('nombre')?.hasError('minlength')) {
                <mat-error
                  >Mínimo 2 caracteres</mat-error
                  >
                }
                @if (registroForm.get('nombre')?.hasError('pattern')) {
                  <mat-error
                    >Solo letras</mat-error
                    >
                  }
                </mat-form-field>
                <!-- Apellido -->
                <mat-form-field
                  appearance="fill"
                  class="col-span-1"
        [ngClass]="{
    'mat-form-field-valid': registroForm.get('apellido')?.valid && (registroForm.get('apellido')?.dirty || registroForm.get('apellido')?.touched),
    'mat-form-field-invalid': registroForm.get('apellido')?.invalid && (registroForm.get('apellido')?.dirty || registroForm.get('apellido')?.touched)
  }"
                  >
                  <mat-label>Apellido</mat-label>
                  <input matInput formControlName="apellido" />
                  @if (registroForm.get('apellido')?.hasError('required')) {
                    <mat-error
                      >Campo obligatorio</mat-error
                      >
                    }
                    @if (registroForm.get('apellido')?.hasError('minlength')) {
                      <mat-error
                        >Mínimo 2 caracteres</mat-error
                        >
                      }
                      @if (registroForm.get('apellido')?.hasError('pattern')) {
                        <mat-error
                          >Solo letras</mat-error
                          >
                        }
                      </mat-form-field>
                      <!-- Edad -->
                      <mat-form-field
                        appearance="fill"
                        class="col-span-1"
        [ngClass]="{
    'mat-form-field-valid': registroForm.get('edad')?.valid && (registroForm.get('edad')?.dirty || registroForm.get('edad')?.touched),
    'mat-form-field-invalid': registroForm.get('edad')?.invalid && (registroForm.get('edad')?.dirty || registroForm.get('edad')?.touched)
  }"
                        >
                        <mat-label>Edad</mat-label>
                        <input matInput type="number" formControlName="edad" />
                        @if (registroForm.get('edad')?.hasError('required')) {
                          <mat-error
                            >Campo obligatorio</mat-error
                            >
                          }
                          @if (registroForm.get('edad')?.hasError('min')) {
                            <mat-error
                              >Mínimo 18</mat-error
                              >
                            }
                            @if (registroForm.get('edad')?.hasError('max')) {
                              <mat-error
                                >Máximo 99</mat-error
                                >
                              }
                            </mat-form-field>
                            <!-- DNI -->
                            <mat-form-field
                              appearance="fill"
                              class="col-span-1"
        [ngClass]="{
    'mat-form-field-valid': registroForm.get('dni')?.valid && (registroForm.get('dni')?.dirty || registroForm.get('dni')?.touched),
    'mat-form-field-invalid': registroForm.get('dni')?.invalid && (registroForm.get('dni')?.dirty || registroForm.get('dni')?.touched)
  }"
                              >
                              <mat-label>DNI</mat-label>
                              <input matInput formControlName="dni" />
                              @if (registroForm.get('dni')?.hasError('required')) {
                                <mat-error
                                  >Campo obligatorio</mat-error
                                  >
                                }
                                @if (registroForm.get('dni')?.hasError('pattern')) {
                                  <mat-error
                                    >Debe contener 8 dígitos</mat-error
                                    >
                                  }
                                </mat-form-field>
                                <!-- Obra Social -->
                                @if (tipoUsuario === 'paciente') {
                                  <mat-form-field
                                    appearance="fill"
                                    class="col-span-1"
        [ngClass]="{
    'mat-form-field-valid': registroForm.get('obraSocial')?.valid && (registroForm.get('obraSocial')?.dirty || registroForm.get('obraSocial')?.touched),
    'mat-form-field-invalid': registroForm.get('obraSocial')?.invalid && (registroForm.get('obraSocial')?.dirty || registroForm.get('obraSocial')?.touched)
  }"
                                    >
                                    <mat-label>Obra Social</mat-label>
                                    <mat-select formControlName="obraSocial">
                                      @for (obra of obraSocialOptions; track obra) {
                                        <mat-option [value]="obra"
                                          >{{ obra }}</mat-option
                                          >
                                        }
                                      </mat-select>
                                      @if (registroForm.get('obraSocial')?.hasError('required')) {
                                        <mat-error
                                          >Campo obligatorio</mat-error
                                          >
                                        }
                                      </mat-form-field>
                                    }
                                    <!-- Mail -->
                                    <mat-form-field
                                      appearance="fill"
                                      class="col-span-1"
        [ngClass]="{
    'mat-form-field-valid': registroForm.get('mail')?.valid && (registroForm.get('mail')?.dirty || registroForm.get('mail')?.touched),
    'mat-form-field-invalid': registroForm.get('mail')?.invalid && (registroForm.get('mail')?.dirty || registroForm.get('mail')?.touched)
  }"
                                      >
                                      <mat-label>Email</mat-label>
                                      <input matInput type="email" formControlName="mail" />
                                      @if (registroForm.get('mail')?.hasError('required')) {
                                        <mat-error
                                          >Campo obligatorio</mat-error
                                          >
                                        }
                                        @if (registroForm.get('mail')?.hasError('email')) {
                                          <mat-error
                                            >Email inválido</mat-error
                                            >
                                          }
                                        </mat-form-field>
                                        <!-- Password -->
                                        <mat-form-field
                                          appearance="fill"
                                          class="col-span-1"
        [ngClass]="{
    'mat-form-field-valid': registroForm.get('password')?.valid && (registroForm.get('password')?.dirty || registroForm.get('password')?.touched),
    'mat-form-field-invalid': registroForm.get('password')?.invalid && (registroForm.get('password')?.dirty || registroForm.get('password')?.touched)
  }"
                                          >
                                          <mat-label>Contraseña</mat-label>
                                          <input matInput type="password" formControlName="password" />
                                          @if (registroForm.get('password')?.hasError('required')) {
                                            <mat-error
                                              >Campo obligatorio</mat-error
                                              >
                                            }
                                            @if (registroForm.get('password')?.hasError('minlength')) {
                                              <mat-error
                                                >Mínimo 7 caracteres</mat-error
                                                >
                                              }
                                            </mat-form-field>
                                            <!-- Especialidades (Solo especialista) -->
                                            @if (tipoUsuario === 'especialista') {
                                              <div class="col-span-2">
                                                <div class="mb-1 text-sm font-medium text-azul-oscuro">
                                                  Especialidades (seleccioná al menos una)
                                                </div>
                                                <div class="relative">
                                                  <div
                                                    class="flex min-h-[56px] cursor-pointer items-center rounded-md border border-gray-300 bg-white px-4 py-3 transition-colors hover:border-azul-oscuro"
                                                    (click)="toggleDesplegableEspecialidades($event)"
                                                    (keyup.enter)="toggleDesplegableEspecialidades($event)"
                                                    (keyup.space)="toggleDesplegableEspecialidades($event)"
                                                    tabindex="0"
                                                    [class.border-azul-oscuro]="desplegableEspecialidadesAbierto"
                                                    >
                                                    <span class="flex-1 text-sm text-gray-700">
                                                      {{ obtenerEspecialidadesSeleccionadasTexto() }}
                                                    </span>
                                                    <mat-icon class="text-gray-500"
                                                      >{{ desplegableEspecialidadesAbierto ? "expand_less" :
                                                      "expand_more" }}</mat-icon
                                                      >
                                                    </div>
                                                    <!-- Desplegable con checkboxes -->
                                                    @if (desplegableEspecialidadesAbierto) {
                                                      <div
                                                        class="absolute top-full right-0 left-0 z-10 mt-1 max-h-60 overflow-y-auto rounded-lg border border-gray-300 bg-white p-3 shadow-lg"
                                                        >
                                                        <div class="space-y-2">
                                                          @for (especialidad of especialidadOptions; track especialidad) {
                                                            <mat-checkbox
                                                              [checked]="esEspecialidadSeleccionada(especialidad.id)"
                                                              (change)="toggleEspecialidad(especialidad.id)"
                                                              class="block text-sm"
                                                              >
                                                              {{ especialidad.nombre }}
                                                            </mat-checkbox>
                                                          }
                                                        </div>
                                                        <!-- Botón para agregar nueva especialidad -->
                                                        <div class="mt-3 border-t pt-2">
                                                          <button
                                                            type="button"
                                                            mat-button
                                                            (click)="toggleMostrarNuevaEspecialidad(); $event.stopPropagation()"
                                                            class="w-full text-left text-sm text-azul-oscuro"
                                                            >
                                                            {{ mostrarCampoOtraEspecialidad ? "✕ Cancelar" : "+ Agregar
                                                            nueva especialidad" }}
                                                          </button>
                                                          <!-- Campo para nueva especialidad dentro del desplegable -->
                                                          @if (mostrarCampoOtraEspecialidad) {
                                                            <div class="mt-2">
                                                              <input
                                                                formControlName="nuevaEspecialidad"
                                                                placeholder="Nombre de la especialidad"
                                                                class="w-full rounded border border-gray-300 px-3 py-2 text-sm focus:border-azul-oscuro focus:outline-none"
                                                                (click)="$event.stopPropagation()"
                                                                />
                                                                @if (registroForm.get('nuevaEspecialidad')?.hasError('minlength')) {
                                                                  <div
                                                                    class="mt-1 text-xs text-red-600"
                                                                    >
                                                                    Mínimo 2 caracteres
                                                                  </div>
                                                                }
                                                                @if (registroForm.get('nuevaEspecialidad')?.hasError('pattern')) {
                                                                  <div
                                                                    class="mt-1 text-xs text-red-600"
                                                                    >
                                                                    Solo letras y espacios
                                                                  </div>
                                                                }
                                                              </div>
                                                            }
                                                          </div>
                                                        </div>
                                                      }
                                                    </div>
                                                    <!-- Error si no hay especialidades seleccionadas -->
                                                    @if (registroForm.get('especialidadesSeleccionadas')?.hasError('alMenosUna') &&
                                                      registroForm.get('especialidadesSeleccionadas')?.touched) {
                                                      <div
                                                        class="mt-1 text-sm text-red-600"
                                                        >
                                                        Debés seleccionar al menos una especialidad o agregar una nueva
                                                      </div>
                                                    }
                                                  </div>
                                                }
                                                <!-- Imagen de perfil -->
                                                <div class="col-span-2 flex flex-col gap-2">
                                                  <label for="fotoPerfil" class="font-semibold text-azul-oscuro"
                                                    >Foto Perfil</label
                                                    >
                                                    <input
                                                      id="fotoPerfil"
                                                      type="file"
                                                      (change)="onFileSelected($event, 'perfil')"
                                                      class="register-input"
                                                      accept="image/*"
                                                      />
                                                      @if (registroForm.get('imagenPerfil')?.hasError('required')) {
                                                        <mat-error
                                                          >
                                                          Debe seleccionar una imagen de perfil.
                                                        </mat-error>
                                                      }
                                                      @if (registroForm.get('imagen')?.hasError('invalidType')) {
                                                        <mat-error>
                                                          Solo se permiten archivos .jpg o .png
                                                        </mat-error>
                                                      }
                                                    </div>
                                                    <!-- Imagen de fondo (solo paciente) -->
                                                    @if (tipoUsuario==='paciente') {
                                                      <div
                                                        class="col-span-2 flex flex-col gap-2"
                                                        >
                                                        <label for="fotoFondo" class="font-semibold text-azul-oscuro"
                                                          >Foto Fondo</label
                                                          >
                                                          <input
                                                            id="fotoFondo"
                                                            type="file"
                                                            (change)="onFileSelected($event, 'fondo')"
                                                            class="register-input"
                                                            accept="image/*"
                                                            />
                                                            @if (registroForm.get('imagenFondo')?.hasError('required')) {
                                                              <mat-error
                                                                >
                                                                Debe seleccionar una imagen de fondo.
                                                              </mat-error>
                                                            }
                                                            @if (registroForm.get('imagen')?.hasError('invalidType')) {
                                                              <mat-error>
                                                                Solo se permiten archivos .jpg o .png
                                                              </mat-error>
                                                            }
                                                          </div>
                                                        }
                                                        <!-- Botón -->
                                                        <div class="col-span-2 flex justify-center pt-4">
                                                          <button
                                                            mat-raised-button
                                                            color="primary"
                                                            [disabled]="registroForm.invalid"
                                                            type="submit"
                                                            class="flex items-center justify-center gap-2 rounded-full bg-verde-oscuro px-8 py-2 text-white shadow-lg"
                                                            >
                                                            <span>Registrarse</span>
                                                          </button>
                                                        </div>
                                                        <!-- Cambiar tipo -->
                                                        <div class="col-span-2 mt-1 flex justify-center">
                                                          <button
                                                            mat-button
                                                            type="button"
                                                            (click)="tipoUsuario = null"
                                                            class="text-sm text-gray-600 underline"
                                                            >
                                                            Cambiar tipo de usuario
                                                          </button>
                                                        </div>
                                                        <div class="col-span-2 mt-1 flex flex-col items-center">
                                                          <!-- Mensaje de error arriba -->
                                                          @if (registroForm.errors?.['captchaInvalido'] && registroForm.touched) {
                                                            <div
                                                              class="mb-2 text-center text-sm text-red-600"
                                                              >
                                                              Debe resolver correctamente el CAPTCHA.
                                                            </div>
                                                          }
                                                          <!-- Componente captcha -->
                                                          <app-mi-captcha (captchaResuelto)="onCaptchaResuelto($event)" />
                                                        </div>
                                                      </form>
                                                    </div>
                                                  }
                                                </div>
