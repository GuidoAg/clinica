import{b as t}from"./chunk-QU5QNJKE.js";import{U as N}from"./chunk-7RTQA4J5.js";import{a as P,b as I,i as n}from"./chunk-ODN5LVDJ.js";var A=class b{obtenerEspecialistas(){return n(this,null,function*(){let{data:e,error:i}=yield t.from("vista_perfiles_con_email").select(`
      id,
      auth_id,
      nombre,
      apellido,
      edad,
      dni,
      url_imagen_perfil, 
      rol,
      email,
      email_verificado_real,
      detalles_paciente (
        obra_social,
        url_imagen_fondo
      ),
      detalles_especialista (
        validado_admin,
        activo
      ),
      especialista_especialidades (
        duracion,
        especialidades (
          id,
          nombre,
          url_icono
        )
      )
    `).eq("rol","especialista").eq("email_verificado_real",!0);return i||!e?(console.error("Error al obtener usuarios:",i),[]):e.map(r=>{let o=Array.isArray(r.detalles_especialista)?r.detalles_especialista[0]:r.detalles_especialista??null;return{id:r.id,nombre:r.nombre,apellido:r.apellido,imagenPerfil:r.url_imagen_perfil,emailVerificado:r.email_verificado_real??!1,validadoAdmin:o?.validado_admin??!1,activo:o.activo??!1}})})}obtenerEspecialistasConDisponibilidad(e=15){return n(this,null,function*(){let i=yield this.obtenerEspecialistas(),r=[];for(let o of i)o.validadoAdmin===!0&&(yield this.especialistaTieneDisponibilidad(o.id,e))&&r.push(o);return r})}obtenerEspecialidadesDeEspecialista(e){return n(this,null,function*(){let{data:i,error:r}=yield t.from("vista_especialista_especialidades").select(`
          especialista_id,
          especialidad_id,
          nombre_especialidad,
          url_icono,
          duracion_minutos
        `).eq("especialista_id",e);return r||!i?(console.error("Error al obtener usuarios:",r),[]):i.map(o=>({id:o.especialidad_id,nombre:o.nombre_especialidad,icono:o.url_icono,duracion:o.duracion_minutos}))})}obtenerDiasEspecialista(e){return n(this,null,function*(){let{data:i,error:r}=yield t.from("disponibilidades").select("dia_semana").eq("perfil_id",e).eq("habilitado",!0);if(r||!i)return console.error("Error al obtener d\xEDas disponibles:",r),[];let o={1:"lunes",2:"martes",3:"mi\xE9rcoles",4:"jueves",5:"viernes",6:"s\xE1bado",7:"domingo"};return i.map(s=>o[s.dia_semana]).filter((s,a,p)=>s&&p.indexOf(s)===a)})}calcularFechasDisponibles(o){return n(this,arguments,function*(e,i=15,r=new Date){let c=yield this.obtenerDiasEspecialista(e),s={lunes:1,martes:2,mi\u00E9rcoles:3,jueves:4,viernes:5,s\u00E1bado:6,domingo:0},a=c.map(m=>s[m.toLowerCase()]),p=[];for(let m=0;m<i;m++){let u=new Date(r);u.setDate(u.getDate()+m);let g=u.getDay();if(a.includes(g)){let h=u.getFullYear(),_=String(u.getMonth()+1).padStart(2,"0"),C=String(u.getDate()).padStart(2,"0");p.push(`${h}-${_}-${C}`)}}return p})}obtenerFechasConHorariosDisponibles(c,s){return n(this,arguments,function*(e,i,r=15,o=new Date){let a=yield this.calcularFechasDisponibles(e,r,o),p=[];for(let m of a)(yield this.obtenerHorariosDisponibles(m,e,i)).length>0&&p.push(m);return p})}especialistaTieneDisponibilidad(e,i=15){return n(this,null,function*(){let r=yield this.obtenerEspecialidadesDeEspecialista(e);if(r.length===0)return!1;for(let o of r)if((yield this.obtenerFechasConHorariosDisponibles(e,o.duracion,i)).length>0)return!0;return!1})}obtenerHorariosDisponibles(e,i,r){return n(this,null,function*(){let[o,c,s]=e.split("-").map(Number),p=(new Date(o,c-1,s).getDay()+6)%7+1,{data:m,error:u}=yield t.from("disponibilidades").select("hora_inicio, hora_fin").eq("perfil_id",i).eq("dia_semana",p).eq("habilitado",!0).maybeSingle();if(u||!m)return console.error("Sin disponibilidad:",u),[];let{hora_inicio:g,hora_fin:h}=m;function _(d,l){let[T,z,H]=d.split("-").map(Number),[x,O]=l.split(":").map(Number);return new Date(T,z-1,H,x,O)}let C=_(e,g),D=_(e,h),q=new Date(`${e}T00:00:00`),R=new Date(`${e}T23:59:59`),{data:S,error:E}=yield t.from("citas").select("fecha_hora, duracion_min").eq("especialista_id",i).neq("estado","cancelado").neq("estado","rechazado").gte("fecha_hora",q.toISOString()).lte("fecha_hora",R.toISOString());if(E)return console.error("Error al obtener citas:",E),[];let y=(S||[]).map(d=>{let l=new Date(d.fecha_hora),T=new Date(l.getTime()+d.duracion_min*6e4);return{inicio:l,fin:T}});y.sort((d,l)=>d.inicio.getTime()-l.inicio.getTime());let w=[],f=new Date(C);for(let d of y){if(f<d.inicio){let l=new Date(Math.min(d.inicio.getTime(),D.getTime()));f<l&&w.push({inicio:new Date(f),fin:l})}d.fin>f&&(f=new Date(Math.max(f.getTime(),d.fin.getTime())))}f<D&&w.push({inicio:f,fin:D});let v=[];for(let d of w){let l=new Date(d.inicio);for(;l.getTime()+r*6e4<=d.fin.getTime();)v.push(l.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:!1})),l=new Date(l.getTime()+r*6e4)}return v})}darAltaCita(e){return n(this,null,function*(){try{let{data:i,error:r}=yield t.from("citas").insert({fecha_hora:e.fechaHora.toISOString(),duracion_min:e.duracionMin,paciente_id:e.pacienteId,especialista_id:e.especialistaId,especialidad_id:e.especialidadId,estado:e.estado,comentario_paciente:e.comentarioPaciente,comentario_especialista:e.comentarioEspecialista,resenia:e.resenia}).select().maybeSingle();return r||!i?(console.error("Error al insertar cita:",r),{success:!1,message:"No se pudo registrar la cita",errorCode:r?.code??"insert_error"}):{success:!0,data:I(P({},e),{fechaHora:new Date(i.fecha_hora)})}}catch(i){return console.error("Excepci\xF3n en darAltaCita:",i),{success:!1,message:"Ocurri\xF3 un error inesperado",errorCode:"unexpected_error"}}})}obtenerCitasConRegistro(){return n(this,null,function*(){let{data:e,error:i}=yield t.from("vista_citas_enteras").select("*");if(i)throw new Error(`Error al obtener citas: ${i.message}`);if(!e)return[];let{data:r,error:o}=yield t.from("datos_medicos_dinamicos").select("*");if(o)throw new Error(`Error al obtener datos din\xE1micos: ${o.message}`);let c={};for(let s of r||[])s.cita_id&&(c[s.cita_id]||(c[s.cita_id]=[]),c[s.cita_id].push({id:s.id,clave:s.clave,valor:s.valor,citaId:s.cita_id}));return e.map(s=>({citaId:s.cita_id,fechaHora:new Date(s.fecha_hora),duracionMin:s.duracion_min,estado:s.estado,comentarioPaciente:s.comentario_paciente??"",comentarioEspecialista:s.comentario_especialista??"",resenia:s.resenia??"",pacienteId:s.paciente_id,pacienteNombreCompleto:s.paciente_nombre_completo,especialistaId:s.especialista_id,especialistaNombreCompleto:s.especialista_nombre_completo,especialidadId:s.especialidad_id,especialidadNombre:s.especialidad_nombre,alturaCm:Number(s.altura_cm),pesoKg:Number(s.peso_kg),temperaturaC:Number(s.temperatura_c),presionArterial:s.presion_arterial??"",datosDinamicos:c[s.cita_id]||[]}))})}obtenerCitasPaciente(e){return n(this,null,function*(){let{data:i,error:r}=yield t.from("vista_citas_enteras").select("*").eq("paciente_id",e);if(r)throw new Error(`Error al obtener citas: ${r.message}`);if(!i)return[];let{data:o,error:c}=yield t.from("datos_medicos_dinamicos").select("*");if(c)throw new Error(`Error al obtener datos din\xE1micos: ${c.message}`);let s={};for(let a of o||[])a.cita_id&&(s[a.cita_id]||(s[a.cita_id]=[]),s[a.cita_id].push({id:a.id,clave:a.clave,valor:a.valor,citaId:a.cita_id}));return i.map(a=>({citaId:a.cita_id,fechaHora:new Date(a.fecha_hora),duracionMin:a.duracion_min,estado:a.estado,comentarioPaciente:a.comentario_paciente??"",comentarioEspecialista:a.comentario_especialista??"",resenia:a.resenia??"",pacienteId:a.paciente_id,pacienteNombreCompleto:a.paciente_nombre_completo,especialistaId:a.especialista_id,especialistaNombreCompleto:a.especialista_nombre_completo,especialidadId:a.especialidad_id,especialidadNombre:a.especialidad_nombre,alturaCm:Number(a.altura_cm),pesoKg:Number(a.peso_kg),temperaturaC:Number(a.temperatura_c),presionArterial:a.presion_arterial??"",datosDinamicos:s[a.cita_id]||[]}))})}cancelarCitaPaciente(e,i){return n(this,null,function*(){if(e.estado==="completado")return{success:!1,message:"No se puede cancelar un turno ya realizado."};let{error:r}=yield t.from("citas").update({estado:"cancelado",comentario_paciente:i}).eq("id",e.citaId);return r?{success:!1,message:"Ocurri\xF3 un error al cancelar el turno."}:{success:!0,message:"Turno cancelado exitosamente.",data:!0}})}cargarEncuesta(e,i){return n(this,null,function*(){if(e.estado!=="completado")return{success:!1,message:"El turno debe ser realizado para poder cargar encuesta."};if(!e.resenia||e.resenia.trim()==="")return{success:!1,message:"El especialista debe cargar una rese\xF1a antes de poder cargar una encuesta"};let{data:r,error:o}=yield t.from("encuesta").insert({id:e.citaId,pregunta1:i.pregunta1,pregunta2:i.pregunta2,pregunta3:i.pregunta3,nombre:i.nombre,telefono:i.telefono}).select().maybeSingle();return o||!r?{success:!1,message:"No se pudo registrar la encuesta",errorCode:o?.code??"insert_error"}:{success:!0,message:"Encuesta registrada exitosamente.",data:!0}})}cargarComentarioAtencion(e,i){return n(this,null,function*(){if(e.estado!=="completado")return{success:!1,message:"El turno debe ser realizado para poder calificar la atencion."};let{error:r}=yield t.from("citas").update({comentario_paciente:i}).eq("id",e.citaId);return r?{success:!1,message:"No se pudo registrar la calificacion",errorCode:r?.code??"insert_error"}:{success:!0,message:"Antencion calificada exitosamente.",data:!0}})}cancelarCitaEspecialista(e,i){return n(this,null,function*(){if(e.estado==="completado"||e.estado==="aceptado"||e.estado==="rechazado")return{success:!1,message:"No se puede cancelar un turno ya realizado, aceptado o rechazado."};let{error:r}=yield t.from("citas").update({estado:"cancelado",comentario_especialista:i}).eq("id",e.citaId);return r?{success:!1,message:"Ocurri\xF3 un error al cancelar el turno."}:{success:!0,message:"Turno cancelado exitosamente.",data:!0}})}rechazarCitaEspecialista(e,i){return n(this,null,function*(){if(e.estado==="completado"||e.estado==="aceptado"||e.estado==="cancelado")return{success:!1,message:"No se puede rechazar un turno ya realizado, aceptado o cancelado."};let{error:r}=yield t.from("citas").update({estado:"rechazado",comentario_especialista:i}).eq("id",e.citaId);return r?{success:!1,message:"Ocurri\xF3 un error al rechazar el turno."}:{success:!0,message:"Turno rechazado exitosamente.",data:!0}})}aceptarCitaEspecialista(e){return n(this,null,function*(){if(e.estado==="completado"||e.estado==="rechazado"||e.estado==="cancelado")return{success:!1,message:"No se puede aceprtar un turno ya realizado, rechazado o cancelado."};let{error:i}=yield t.from("citas").update({estado:"aceptado"}).eq("id",e.citaId);return i?{success:!1,message:"Ocurri\xF3 un error al aceptar el turno."}:{success:!0,message:"Turno aceptado exitosamente.",data:!0}})}completarCitaEspecialista(e,i){return n(this,null,function*(){if(e.estado!=="aceptado")return{success:!1,message:"No se puede finalizar un turno que no fue aceptado."};let{error:r}=yield t.from("citas").update({estado:"completado",resenia:i}).eq("id",e.citaId);return r?{success:!1,message:"Ocurri\xF3 un error al completar el turno."}:{success:!0,message:"Turno completado exitosamente.",data:!0}})}obtenerCitasEspecialista(e){return n(this,null,function*(){let{data:i,error:r}=yield t.from("vista_citas_enteras").select("*").eq("especialista_id",e);if(r)throw new Error(`Error al obtener citas: ${r.message}`);if(!i)return[];let{data:o,error:c}=yield t.from("datos_medicos_dinamicos").select("*");if(c)throw new Error(`Error al obtener datos din\xE1micos: ${c.message}`);let s={};for(let a of o||[])a.cita_id&&(s[a.cita_id]||(s[a.cita_id]=[]),s[a.cita_id].push({id:a.id,clave:a.clave,valor:a.valor,citaId:a.cita_id}));return i.map(a=>({citaId:a.cita_id,fechaHora:new Date(a.fecha_hora),duracionMin:a.duracion_min,estado:a.estado,comentarioPaciente:a.comentario_paciente??"",comentarioEspecialista:a.comentario_especialista??"",resenia:a.resenia??"",pacienteId:a.paciente_id,pacienteNombreCompleto:a.paciente_nombre_completo,especialistaId:a.especialista_id,especialistaNombreCompleto:a.especialista_nombre_completo,especialidadId:a.especialidad_id,especialidadNombre:a.especialidad_nombre,alturaCm:Number(a.altura_cm),pesoKg:Number(a.peso_kg),temperaturaC:Number(a.temperatura_c),presionArterial:a.presion_arterial??"",datosDinamicos:s[a.cita_id]||[]}))})}cargarHistoriaClinica(e,i){return n(this,null,function*(){if(i.length<1||i.length>6)return{success:!1,message:"Debe cargar entre 1 y 6 datos m\xE9dicos din\xE1micos"};let{error:r}=yield t.from("registros_medicos").insert({cita_id:e.citaId,altura_cm:e.alturaCm,peso_kg:e.pesoKg,temperatura_c:e.temperaturaC,presion_arterial:e.presionArterial});if(r)return{success:!1,message:"Error al guardar los datos principales de la historia cl\xEDnica"};let o=i.map(s=>({cita_id:e.citaId,clave:s.clave,valor:s.valor})),{error:c}=yield t.from("datos_medicos_dinamicos").insert(o);return c?{success:!1,message:"Error al guardar los datos adicionales de la historia cl\xEDnica"}:{success:!0,message:"Historia cl\xEDnica guardada correctamente"}})}static \u0275fac=function(i){return new(i||b)};static \u0275prov=N({token:b,factory:b.\u0275fac,providedIn:"root"})};export{A as a};
