import{a as v,b as i,c as u,h as P}from"./chunk-YDT6XDAL.js";import{U as A,g as w}from"./chunk-PTIYVII4.js";import{a as h,j as c}from"./chunk-K4ALXBGI.js";function x(a,e){let r=a.split(","),s=r[0].match(/:(.*?);/)?.[1]||"image/png",t=atob(r[1]),n=t.length,o=new Uint8Array(n);for(;n--;)o[n]=t.charCodeAt(n);return new File([o],e,{type:s})}function D(a){return new Promise((e,r)=>{let s=new FileReader;s.onload=()=>{let t=s.result;typeof t=="string"?e(t):r("No se pudo leer el archivo como base64.")},s.onerror=()=>r(s.error),s.readAsDataURL(a)})}function g(a,e,r){return c(this,null,function*(){try{let s=Date.now(),t=`${e}/${r}-${s}.png`,n=x(a,`${r}.png`),{error:o}=yield i.storage.from("imagenes").upload(t,n,{upsert:!0});if(o)return{success:!1,message:"No se pudo subir la imagen."};let{data:l}=i.storage.from("imagenes").getPublicUrl(t);return l?.publicUrl?{success:!0,data:l.publicUrl}:{success:!1,message:"No se pudo obtener la URL p\xFAblica."}}catch{return{success:!1,message:"Error inesperado al subir la imagen."}}})}function I(a,e){return{id:Number(a.id),auth_id:a.auth_id,nombre:a.nombre,apellido:a.apellido,edad:String(a.edad),dni:a.dni,urlImagenPerfil:a.url_imagen_perfil??void 0,emailVerificado:a.email_verificado,rol:a.rol,email:e,obraSocial:a.detalles_paciente?.obra_social??void 0,urlImagenFondo:a.detalles_paciente?.url_imagen_fondo??void 0,validadoAdmin:a.detalles_especialista?.validado_admin,activo:a.detalles_especialista?.activo,especialidades:a.especialista_especialidades?.map(r=>({id:r.especialidades.id,nombre:r.especialidades.nombre,urlIcono:r.especialidades.url_icono??void 0,duracion:r.duracion??void 0}))??[]}}function d(a){if(!a)return"Error desconocido";if(v(a))switch(a.code){case"invalid_credentials":return"Email o contrase\xF1a incorrectos.";case"email_not_confirmed":return"Debes verificar tu email antes de poder ingresar.";case"user_already_exists":case"email_exists":return"Ya existe una cuenta registrada con este email.";case"email_address_invalid":return"El email ingresado no es v\xE1lido.";case"unexpected_failure":return"Ha ocurrido un error inesperado. Intente m\xE1s tarde.";case"especialista_no_validado":return"Tu cuenta a\xFAn no fue validada por un administrador.";default:return"Error desconocido. Intente nuevamente."}return"Error desconocido"}var U=class a{userSubject=new w(null);user$=this.userSubject.asObservable();constructor(){this.restoreUserFromSession()}getCurrentUser(){return this.userSubject.getValue()}setCurrentUser(e){this.userSubject.next(e)}updateCurrentUser(e){let r=this.getCurrentUser();r&&this.userSubject.next(h(h({},r),e))}recargarUsuario(){return c(this,null,function*(){let e=this.getCurrentUser();e&&(yield this.loadUsuarioDesdePerfil(e.auth_id,e.email))})}getAvatarUrl(e){return i.storage.from("imagenes").getPublicUrl(e).data.publicUrl}restoreUserFromSession(){return c(this,null,function*(){let{data:e,error:r}=yield i.auth.getUser();if(r?.message==="User from sub claim in JWT does not exist"){yield i.auth.signOut(),localStorage.clear(),sessionStorage.clear(),this.userSubject.next(null);return}if(!e.user||!e.user.id){this.userSubject.next(null);return}yield this.loadUsuarioDesdePerfil(e.user.id,e.user.email??"")})}loadUsuarioDesdePerfil(e,r){return c(this,null,function*(){if(!e)return this.userSubject.next(null),{success:!1};let{data:s,error:t}=yield i.from(u.PERFILES).select(`
        id,
        auth_id,
        nombre,
        apellido,
        edad,
        dni,
        url_imagen_perfil,
        email_verificado,
        rol,
        detalles_paciente (
          obra_social,
          url_imagen_fondo
        ),
        detalles_especialista (
          validado_admin,
          activo
        ),
        especialista_especialidades (
        duracion,
          especialidades (
            id,
            nombre,
            url_icono
          )
        )
      `).eq("auth_id",e).maybeSingle();if(t||!s)return this.userSubject.next(null),{success:!1};let n=I(s,r);if(n.rol==="especialista"&&!n.validadoAdmin)return this.userSubject.next(null),{success:!1,errorCode:"Tu cuenta a\xFAn no fue validada por un administrador"};if(!n.emailVerificado){let{error:o}=yield i.from(u.PERFILES).update({email_verificado:!0}).eq("auth_id",e);if(o)return console.error("Error al actualizar email_verificado:",o),{success:!1,errorCode:"No se pudo actualizar el estado de verificaci\xF3n del email"};n.emailVerificado=!0}return this.userSubject.next(n),{success:!0}})}login(e,r){return c(this,null,function*(){let{data:s,error:t}=yield i.auth.signInWithPassword({email:e,password:r});if(t||!s.user)return{success:!1,errorCode:d(t),message:t?.message??"Error desconocido al iniciar sesi\xF3n"};let n=yield this.loadUsuarioDesdePerfil(s.user.id,s.user.email??"");return n.success==!1?n:{success:!0}})}logout(){return c(this,null,function*(){yield i.auth.signOut(),this.userSubject.next(null)})}registerPaciente(e){return c(this,null,function*(){let{data:r,error:s}=yield i.auth.signUp({email:e.mail,password:e.contrasena});if(r?.user?.identities?.length===0)return{success:!1,errorCode:d(s),message:"Ya existe una cuenta registrada con este email."};if(s||!r.user)return{success:!1,errorCode:d(s),message:s?.message??"Error desconocido al registrar"};let t=r.user.id,n=e.nombre.replace(/\s+/g,""),o=yield g(e.imagenPerfil,"fotoPerfilPaciente",`perfil-${n}`);if(!o.success||!o.data)return{success:!1,message:o.message};let l=yield g(e.imagenFondo,"fotoFondoPaciente",`fondo-${n}`);if(!l.success||!l.data)return{success:!1,message:l.message};let{data:m,error:f}=yield i.from(u.PERFILES).insert({auth_id:t,nombre:e.nombre,apellido:e.apellido,edad:parseInt(e.edad,10),dni:e.dni,url_imagen_perfil:o.data,rol:"paciente"}).select("id").single();if(f||!m)return{success:!1,message:"Error al guardar el perfil del usuario."};let{error:p}=yield i.from(u.DETALLES_PACIENTE).insert({perfil_id:m.id,obra_social:e.obraSocial,url_imagen_fondo:l.data});return p?{success:!1,message:"Error al guardar la obra social del paciente."}:{success:!0}})}registerEspecialista(e){return c(this,null,function*(){let{data:r,error:s}=yield i.auth.signUp({email:e.mail,password:e.contrasena});if(r?.user?.identities?.length===0)return{success:!1,errorCode:d(s),message:"Ya existe una cuenta registrada con este email."};if(s||!r.user)return{success:!1,errorCode:d(s),message:s?.message??"Error desconocido al iniciar sesi\xF3n"};let t=r.user.id,n=e.nombre.replace(/\s+/g,""),o=yield g(e.imagenPerfil,"fotoPerfilEspecialista",`perfil-${n}`);if(!o.success||!o.data)return{success:!1,message:o.message};let{data:l,error:m}=yield i.from(u.PERFILES).insert({auth_id:t,nombre:e.nombre,apellido:e.apellido,edad:parseInt(e.edad,10),dni:e.dni,url_imagen_perfil:o.data,rol:"especialista"}).select("id").single();if(m||!l)return{success:!1,message:"Error al guardar el perfil del especialista."};let{error:f}=yield i.from(u.DETALLES_ESPECIALISTA).insert({perfil_id:l.id,validado_admin:!1,activo:!0});if(f)return{success:!1,message:"Error al guardar los detalles del especialista."};let p=[];for(let E of e.especialidades){let S=Number(E),C=!Number.isInteger(S),_;if(C){let b=yield this.agregarEspecialidadSiNoExiste(String(E));if(!b.success||!b.data)return{success:!1,message:b.message};_=b.data}else _=S;p.push({perfil_id:l.id,especialidad_id:_,duracion:30})}if(p.length>0){let{error:E}=yield i.from(u.ESPECIALISTA_ESPECIALIDADES).insert(p);if(E)return{success:!1,message:"Error al asignar las especialidades al especialista."}}return{success:!0}})}registerAdmin(e){return c(this,null,function*(){let{data:r,error:s}=yield i.auth.signUp({email:e.mail,password:e.contrasena});if(r?.user?.identities?.length===0)return{success:!1,errorCode:d(s),message:"Ya existe una cuenta registrada con este email."};if(s||!r.user)return{success:!1,errorCode:d(s),message:s?.message??"Error desconocido al iniciar sesi\xF3n"};let t=r.user.id,n=e.nombre.replace(/\s+/g,""),o=yield g(e.imagenPerfil,"fotoPerfilAdmin",`perfil-${n}`);if(!o.success||!o.data)return{success:!1,message:o.message};let{error:l}=yield i.from(u.PERFILES).insert({auth_id:t,nombre:e.nombre,apellido:e.apellido,edad:parseInt(e.edad,10),dni:e.dni,url_imagen_perfil:o.data,rol:"admin"});return l?{success:!1,message:"Error al guardar el perfil del admin."}:{success:!0}})}obtenerEspecialidades(){return c(this,null,function*(){let{data:e,error:r}=yield i.from(u.ESPECIALIDADES).select(P.COMPLETO).order("nombre",{ascending:!0});return r||!e?(console.error("Error al obtener especialidades:",r),[]):e.map(s=>({id:s.id,nombre:s.nombre,urlIcono:s.url_icono??void 0}))})}agregarEspecialidadSiNoExiste(e){return c(this,null,function*(){let r=e.trim().toLowerCase(),{data:s,error:t}=yield i.from(u.ESPECIALIDADES).select(P.BASICO).ilike("nombre",r);if(t)return{success:!1,message:"Error al buscar especialidades existentes"};if(s?.some(f=>f.nombre.trim().toLowerCase()===r)&&s?.[0]?.id)return{success:!0,data:s[0].id};let o="https://rtcjwvxzoxhglvqirrel.supabase.co/storage/v1/object/public/imagenes/fotoEspecialidad/default.png",{data:l,error:m}=yield i.from(u.ESPECIALIDADES).insert({nombre:e,url_icono:o}).select("id").single();return m||!l?.id?{success:!1,message:"Error al insertar nueva especialidad."}:{success:!0,data:l.id}})}getCaptchas(){return c(this,null,function*(){let{data:e,error:r}=yield i.from(u.CAPTCHA).select("imagenUrl, respuesta").overrideTypes();return r||!e?(console.error("Error al obtener captchas:",r),[]):e.map(s=>({imagenUrl:s.imagenUrl,answerHash:s.respuesta}))})}registrarIngreso(e){return c(this,null,function*(){let{data:r,error:s}=yield i.from(u.PERFILES).select("rol").eq("id",e).single();if(s||!r){console.error("Error al obtener perfil:",s?.message);return}if(r.rol==="admin")return;let{error:t}=yield i.from(u.REGISTRO_INGRESOS).insert({perfil_id:e});t&&console.error("Error al registrar el ingreso:",t.message)})}static \u0275fac=function(r){return new(r||a)};static \u0275prov=A({token:a,factory:a.\u0275fac,providedIn:"root"})};export{D as a,U as b};
