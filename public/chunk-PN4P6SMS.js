import{b as t}from"./chunk-ICAC2HSA.js";import{T as P}from"./chunk-PO4THZAS.js";import{a as I,b as N,j as n}from"./chunk-TWZW5B45.js";var A=class b{constructor(){}obtenerEspecialistas(){return n(this,null,function*(){let{data:e,error:r}=yield t.from("vista_perfiles_con_email").select(`
      id,
      auth_id,
      nombre,
      apellido,
      edad,
      dni,
      url_imagen_perfil, 
      rol,
      email,
      email_verificado_real,
      detalles_paciente (
        obra_social,
        url_imagen_fondo
      ),
      detalles_especialista (
        validado_admin,
        activo
      ),
      especialista_especialidades (
        duracion,
        especialidades (
          id,
          nombre,
          url_icono
        )
      )
    `).eq("rol","especialista").eq("email_verificado_real",!0);return r||!e?(console.error("Error al obtener usuarios:",r),[]):e.map(o=>{let s=Array.isArray(o.detalles_especialista)?o.detalles_especialista[0]:o.detalles_especialista??null;return{id:o.id,nombre:o.nombre,apellido:o.apellido,imagenPerfil:o.url_imagen_perfil,emailVerificado:o.email_verificado_real??!1,validadoAdmin:s?.validado_admin??!1,activo:s.activo??!1}})})}obtenerEspecialidadesDeEspecialista(e){return n(this,null,function*(){let{data:r,error:o}=yield t.from("vista_especialista_especialidades").select(`
          especialista_id,
          especialidad_id,
          nombre_especialidad,
          url_icono,
          duracion_minutos
        `).eq("especialista_id",e);return o||!r?(console.error("Error al obtener usuarios:",o),[]):r.map(s=>({id:s.especialidad_id,nombre:s.nombre_especialidad,icono:s.url_icono,duracion:s.duracion_minutos}))})}obtenerDiasEspecialista(e){return n(this,null,function*(){let{data:r,error:o}=yield t.from("disponibilidades").select("dia_semana").eq("perfil_id",e).eq("habilitado",!0);if(o||!r)return console.error("Error al obtener d\xEDas disponibles:",o),[];let s={1:"lunes",2:"martes",3:"mi\xE9rcoles",4:"jueves",5:"viernes",6:"s\xE1bado",7:"domingo"};return r.map(i=>s[i.dia_semana]).filter((i,a,f)=>i&&f.indexOf(i)===a)})}calcularFechasDisponibles(s){return n(this,arguments,function*(e,r=15,o=new Date){let c=yield this.obtenerDiasEspecialista(e),i={lunes:1,martes:2,mi\u00E9rcoles:3,jueves:4,viernes:5,s\u00E1bado:6,domingo:0},a=c.map(m=>i[m.toLowerCase()]),f=[];for(let m=0;m<r;m++){let u=new Date(o);u.setDate(u.getDate()+m);let g=u.getDay();if(a.includes(g)){let C=u.getFullYear(),_=String(u.getMonth()+1).padStart(2,"0"),h=String(u.getDate()).padStart(2,"0");f.push(`${C}-${_}-${h}`)}}return f})}obtenerHorariosDisponibles(e,r,o){return n(this,null,function*(){let[s,c,i]=e.split("-").map(Number),f=(new Date(s,c-1,i).getDay()+6)%7+1,{data:m,error:u}=yield t.from("disponibilidades").select("hora_inicio, hora_fin").eq("perfil_id",r).eq("dia_semana",f).eq("habilitado",!0).maybeSingle();if(console.log(m,e,r,o,f),u||!m)return console.error("Sin disponibilidad:",u),[];let{hora_inicio:g,hora_fin:C}=m;function _(d,l){let[T,z,x]=d.split("-").map(Number),[H,O]=l.split(":").map(Number);return new Date(T,z-1,x,H,O)}let h=_(e,g),D=_(e,C),q=new Date(`${e}T00:00:00`),R=new Date(`${e}T23:59:59`),{data:S,error:E}=yield t.from("citas").select("fecha_hora, duracion_min").eq("especialista_id",r).neq("estado","cancelado").gte("fecha_hora",q.toISOString()).lte("fecha_hora",R.toISOString());if(E)return console.error("Error al obtener citas:",E),[];let y=(S||[]).map(d=>{let l=new Date(d.fecha_hora),T=new Date(l.getTime()+d.duracion_min*6e4);return{inicio:l,fin:T}});y.sort((d,l)=>d.inicio.getTime()-l.inicio.getTime());let w=[],p=new Date(h);for(let d of y){if(p<d.inicio){let l=new Date(Math.min(d.inicio.getTime(),D.getTime()));p<l&&w.push({inicio:new Date(p),fin:l})}d.fin>p&&(p=new Date(Math.max(p.getTime(),d.fin.getTime())))}p<D&&w.push({inicio:p,fin:D});let v=[];for(let d of w){let l=new Date(d.inicio);for(;l.getTime()+o*6e4<=d.fin.getTime();)v.push(l.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:!1})),l=new Date(l.getTime()+o*6e4)}return v})}darAltaCita(e){return n(this,null,function*(){try{let{data:r,error:o}=yield t.from("citas").insert({fecha_hora:e.fechaHora.toISOString(),duracion_min:e.duracionMin,paciente_id:e.pacienteId,especialista_id:e.especialistaId,especialidad_id:e.especialidadId,estado:e.estado,comentario_paciente:e.comentarioPaciente,comentario_especialista:e.comentarioEspecialista,resenia:e.resenia}).select().maybeSingle();return o||!r?(console.error("Error al insertar cita:",o),{success:!1,message:"No se pudo registrar la cita",errorCode:o?.code??"insert_error"}):{success:!0,data:N(I({},e),{fechaHora:new Date(r.fecha_hora)})}}catch(r){return console.error("Excepci\xF3n en darAltaCita:",r),{success:!1,message:"Ocurri\xF3 un error inesperado",errorCode:"unexpected_error"}}})}obtenerCitasConRegistro(){return n(this,null,function*(){let{data:e,error:r}=yield t.from("vista_citas_enteras").select("*");if(r)throw new Error(`Error al obtener citas: ${r.message}`);if(!e)return[];let{data:o,error:s}=yield t.from("datos_medicos_dinamicos").select("*");if(s)throw new Error(`Error al obtener datos din\xE1micos: ${s.message}`);let c={};for(let i of o||[])i.cita_id&&(c[i.cita_id]||(c[i.cita_id]=[]),c[i.cita_id].push({id:i.id,clave:i.clave,valor:i.valor,citaId:i.cita_id}));return e.map(i=>({citaId:i.cita_id,fechaHora:new Date(i.fecha_hora),duracionMin:i.duracion_min,estado:i.estado,comentarioPaciente:i.comentario_paciente,comentarioEspecialista:i.comentario_especialista,resenia:i.resenia,pacienteId:i.paciente_id,pacienteNombreCompleto:i.paciente_nombre_completo,especialistaId:i.especialista_id,especialistaNombreCompleto:i.especialista_nombre_completo,especialidadId:i.especialidad_id,especialidadNombre:i.especialidad_nombre,alturaCm:Number(i.altura_cm),pesoKg:Number(i.peso_kg),temperaturaC:Number(i.temperatura_c),presionArterial:i.presion_arterial,datosDinamicos:c[i.cita_id]||[]}))})}obtenerCitasPaciente(e){return n(this,null,function*(){let{data:r,error:o}=yield t.from("vista_citas_enteras").select("*").eq("paciente_id",e);if(o)throw new Error(`Error al obtener citas: ${o.message}`);if(!r)return[];let{data:s,error:c}=yield t.from("datos_medicos_dinamicos").select("*");if(c)throw new Error(`Error al obtener datos din\xE1micos: ${c.message}`);let i={};for(let a of s||[])a.cita_id&&(i[a.cita_id]||(i[a.cita_id]=[]),i[a.cita_id].push({id:a.id,clave:a.clave,valor:a.valor,citaId:a.cita_id}));return r.map(a=>({citaId:a.cita_id,fechaHora:new Date(a.fecha_hora),duracionMin:a.duracion_min,estado:a.estado,comentarioPaciente:a.comentario_paciente,comentarioEspecialista:a.comentario_especialista,resenia:a.resenia,pacienteId:a.paciente_id,pacienteNombreCompleto:a.paciente_nombre_completo,especialistaId:a.especialista_id,especialistaNombreCompleto:a.especialista_nombre_completo,especialidadId:a.especialidad_id,especialidadNombre:a.especialidad_nombre,alturaCm:Number(a.altura_cm),pesoKg:Number(a.peso_kg),temperaturaC:Number(a.temperatura_c),presionArterial:a.presion_arterial,datosDinamicos:i[a.cita_id]||[]}))})}cancelarCitaPaciente(e,r){return n(this,null,function*(){if(e.estado==="completado")return{success:!1,message:"No se puede cancelar un turno ya realizado."};let{error:o}=yield t.from("citas").update({estado:"cancelado",comentario_paciente:r}).eq("id",e.citaId);return o?{success:!1,message:"Ocurri\xF3 un error al cancelar el turno."}:{success:!0,message:"Turno cancelado exitosamente.",data:!0}})}cargarEncuesta(e,r){return n(this,null,function*(){if(e.estado!=="completado")return{success:!1,message:"El turno debe ser realizado para poder cargar encuesta."};if(!e.resenia||e.resenia.trim()==="")return{success:!1,message:"El especialista debe cargar una rese\xF1a antes de poder cargar una encuesta"};let{data:o,error:s}=yield t.from("encuesta").insert({id:e.citaId,pregunta1:r.pregunta1,pregunta2:r.pregunta2,pregunta3:r.pregunta3,nombre:r.nombre,telefono:r.telefono}).select().maybeSingle();return s||!o?{success:!1,message:"No se pudo registrar la encuesta",errorCode:s?.code??"insert_error"}:{success:!0,message:"Encuesta registrada exitosamente.",data:!0}})}cargarComentarioAtencion(e,r){return n(this,null,function*(){if(e.estado!=="completado")return{success:!1,message:"El turno debe ser realizado para poder calificar la atencion."};let{error:o}=yield t.from("citas").update({comentario_paciente:r}).eq("id",e.citaId);return o?{success:!1,message:"No se pudo registrar la calificacion",errorCode:o?.code??"insert_error"}:{success:!0,message:"Antencion calificada exitosamente.",data:!0}})}cancelarCitaEspecialista(e,r){return n(this,null,function*(){if(e.estado==="completado"||e.estado==="aceptado"||e.estado==="rechazado")return{success:!1,message:"No se puede cancelar un turno ya realizado, aceptado o rechazado."};let{error:o}=yield t.from("citas").update({estado:"cancelado",comentario_especialista:r}).eq("id",e.citaId);return o?{success:!1,message:"Ocurri\xF3 un error al cancelar el turno."}:{success:!0,message:"Turno cancelado exitosamente.",data:!0}})}rechazarCitaEspecialista(e,r){return n(this,null,function*(){if(e.estado==="completado"||e.estado==="aceptado"||e.estado==="cancelado")return{success:!1,message:"No se puede rechazar un turno ya realizado, aceptado o cancelado."};let{error:o}=yield t.from("citas").update({estado:"rechazado",comentario_especialista:r}).eq("id",e.citaId);return o?{success:!1,message:"Ocurri\xF3 un error al rechazar el turno."}:{success:!0,message:"Turno rechazado exitosamente.",data:!0}})}aceptarCitaEspecialista(e){return n(this,null,function*(){if(e.estado==="completado"||e.estado==="rechazado"||e.estado==="cancelado")return{success:!1,message:"No se puede aceprtar un turno ya realizado, rechazado o cancelado."};let{error:r}=yield t.from("citas").update({estado:"aceptado"}).eq("id",e.citaId);return r?{success:!1,message:"Ocurri\xF3 un error al aceptar el turno."}:{success:!0,message:"Turno aceptado exitosamente.",data:!0}})}completarCitaEspecialista(e,r){return n(this,null,function*(){if(e.estado!=="aceptado")return{success:!1,message:"No se puede finalizar un turno que no fue aceptado."};let{error:o}=yield t.from("citas").update({estado:"completado",resenia:r}).eq("id",e.citaId);return o?{success:!1,message:"Ocurri\xF3 un error al completar el turno."}:{success:!0,message:"Turno completado exitosamente.",data:!0}})}obtenerCitasEspecialista(e){return n(this,null,function*(){let{data:r,error:o}=yield t.from("vista_citas_enteras").select("*").eq("especialista_id",e);if(o)throw new Error(`Error al obtener citas: ${o.message}`);if(!r)return[];let{data:s,error:c}=yield t.from("datos_medicos_dinamicos").select("*");if(c)throw new Error(`Error al obtener datos din\xE1micos: ${c.message}`);let i={};for(let a of s||[])a.cita_id&&(i[a.cita_id]||(i[a.cita_id]=[]),i[a.cita_id].push({id:a.id,clave:a.clave,valor:a.valor,citaId:a.cita_id}));return r.map(a=>({citaId:a.cita_id,fechaHora:new Date(a.fecha_hora),duracionMin:a.duracion_min,estado:a.estado,comentarioPaciente:a.comentario_paciente,comentarioEspecialista:a.comentario_especialista,resenia:a.resenia,pacienteId:a.paciente_id,pacienteNombreCompleto:a.paciente_nombre_completo,especialistaId:a.especialista_id,especialistaNombreCompleto:a.especialista_nombre_completo,especialidadId:a.especialidad_id,especialidadNombre:a.especialidad_nombre,alturaCm:Number(a.altura_cm),pesoKg:Number(a.peso_kg),temperaturaC:Number(a.temperatura_c),presionArterial:a.presion_arterial,datosDinamicos:i[a.cita_id]||[]}))})}cargarHistoriaClinica(e,r){return n(this,null,function*(){if(r.length<1||r.length>6)return{success:!1,message:"Debe cargar entre 1 y 6 datos m\xE9dicos din\xE1micos"};let{error:o}=yield t.from("registros_medicos").insert({cita_id:e.citaId,altura_cm:e.alturaCm,peso_kg:e.pesoKg,temperatura_c:e.temperaturaC,presion_arterial:e.presionArterial});if(o)return{success:!1,message:"Error al guardar los datos principales de la historia cl\xEDnica"};let s=r.map(i=>({cita_id:e.citaId,clave:i.clave,valor:i.valor})),{error:c}=yield t.from("datos_medicos_dinamicos").insert(s);return c?{success:!1,message:"Error al guardar los datos adicionales de la historia cl\xEDnica"}:{success:!0,message:"Historia cl\xEDnica guardada correctamente"}})}static \u0275fac=function(r){return new(r||b)};static \u0275prov=P({token:b,factory:b.\u0275fac,providedIn:"root"})};export{A as a};
