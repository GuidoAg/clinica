import{a as c,b as l,c as S,d as h,e as M,f as q}from"./chunk-OX45JURR.js";import{U as g,Y as T}from"./chunk-7RTQA4J5.js";import{a as P,b as H,i as s}from"./chunk-ODN5LVDJ.js";var E=class f{DIAS_SEMANA_NUMERO_A_NOMBRE={1:"lunes",2:"martes",3:"mi\xE9rcoles",4:"jueves",5:"viernes",6:"s\xE1bado",7:"domingo"};DIAS_SEMANA_NOMBRE_A_NUMERO={lunes:1,martes:2,mi\u00E9rcoles:3,jueves:4,viernes:5,s\u00E1bado:6,domingo:0};obtenerDiasEspecialista(e){return s(this,null,function*(){let{data:a,error:i}=yield c.from(l.DISPONIBILIDADES).select(S.DIA_SEMANA).eq("perfil_id",e).eq("habilitado",!0);return i||!a?(console.error("Error al obtener d\xEDas disponibles:",i),[]):a.map(o=>this.DIAS_SEMANA_NUMERO_A_NOMBRE[o.dia_semana]).filter((o,t,d)=>o&&d.indexOf(o)===t)})}calcularFechasDisponibles(r){return s(this,arguments,function*(e,a=15,i=new Date){let o=yield this.obtenerDiasEspecialista(e);if(o.length===0)return[];let t=o.map(u=>this.DIAS_SEMANA_NOMBRE_A_NUMERO[u.toLowerCase()]),d=[];for(let u=0;u<a;u++){let m=new Date(i);m.setDate(m.getDate()+u);let C=m.getDay();t.includes(C)&&d.push(this.formatearFecha(m))}return d})}obtenerTodasDisponibilidades(e){return s(this,null,function*(){let{data:a,error:i}=yield c.from(l.DISPONIBILIDADES).select(S.DIA_HORA_INICIO_FIN).eq("perfil_id",e).eq("habilitado",!0);if(i||!a)return new Map;let r=new Map;for(let o of a)r.set(o.dia_semana,{hora_inicio:o.hora_inicio,hora_fin:o.hora_fin});return r})}obtenerDisponibilidadDia(e,a){return s(this,null,function*(){let{data:i,error:r}=yield c.from(l.DISPONIBILIDADES).select(S.DIA_HORA_INICIO_FIN).eq("perfil_id",e).eq("dia_semana",a).eq("habilitado",!0).maybeSingle();return r||!i?null:i})}tieneDisponibilidadConfigurada(e){return s(this,null,function*(){let{data:a,error:i}=yield c.from(l.DISPONIBILIDADES).select(S.SOLO_ID).eq("perfil_id",e).eq("habilitado",!0).limit(1);return!i&&a&&a.length>0})}parseHoraLocal(e,a){let[i,r,o]=e.split("-").map(Number),[t,d]=a.split(":").map(Number);return new Date(i,r-1,o,t,d)}formatearFecha(e){let a=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${a}-${i}-${r}`}formatearHora(e){return e.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:!1})}calcularDiaSemana(e){let[a,i,r]=e.split("-").map(Number);return(new Date(a,i-1,r).getDay()+6)%7+1}crearRangoDia(e){return{inicio:new Date(`${e}T00:00:00`),fin:new Date(`${e}T23:59:59`)}}static \u0275fac=function(a){return new(a||f)};static \u0275prov=g({token:f,factory:f.\u0275fac,providedIn:"root"})};var I=class f{constructor(e){this.disponibilidadService=e}crearRespuestaError(e,a){return{success:!1,message:e,errorCode:a}}crearRespuestaExito(e,a){return{success:!0,message:e,data:a}}verificarSolapamiento(e,a,i,r){return e<r&&a>i}actualizarEstadoCita(e,a,i,r,o,t,d){return s(this,null,function*(){if(i.includes(r))return this.crearRespuestaError(o);let u=P({estado:a},d),{error:m}=yield c.from(l.CITAS).update(u).eq("id",e);return m?this.crearRespuestaError("Ocurri\xF3 un error al actualizar el turno.",m.code):this.crearRespuestaExito(t,!0)})}mapearCitasCompletas(e){return s(this,null,function*(){if(!e||e.length===0)return[];let a=e.map(t=>t.cita_id),{data:i,error:r}=yield c.from(l.DATOS_MEDICOS_DINAMICOS).select(M.TODOS_CAMPOS).in("cita_id",a);if(r)throw new Error(`Error al obtener datos din\xE1micos: ${r.message}`);let o={};for(let t of i||[])t.cita_id&&(o[t.cita_id]||(o[t.cita_id]=[]),o[t.cita_id].push({id:t.id,clave:t.clave,valor:t.valor,citaId:t.cita_id}));return e.map(t=>({citaId:t.cita_id,fechaHora:new Date(t.fecha_hora),duracionMin:t.duracion_min,estado:t.estado,comentarioPaciente:t.comentario_paciente??"",comentarioEspecialista:t.comentario_especialista??"",resenia:t.resenia??"",pacienteId:t.paciente_id,pacienteNombreCompleto:t.paciente_nombre_completo,especialistaId:t.especialista_id,especialistaNombreCompleto:t.especialista_nombre_completo,especialidadId:t.especialidad_id,especialidadNombre:t.especialidad_nombre,alturaCm:Number(t.altura_cm),pesoKg:Number(t.peso_kg),temperaturaC:Number(t.temperatura_c),presionArterial:t.presion_arterial??"",datosDinamicos:o[t.cita_id]||[]}))})}obtenerCitasConRegistro(){return s(this,null,function*(){let{data:e,error:a}=yield c.from(l.VISTA_CITAS_ENTERAS).select("*");if(a)throw new Error(`Error al obtener citas: ${a.message}`);return this.mapearCitasCompletas(e||[])})}obtenerCitasPacienteCompletas(e){return s(this,null,function*(){let{data:a,error:i}=yield c.from(l.VISTA_CITAS_ENTERAS).select("*").eq("paciente_id",e);if(i)throw new Error(`Error al obtener citas: ${i.message}`);return this.mapearCitasCompletas(a||[])})}obtenerCitasEspecialistaCompletas(e){return s(this,null,function*(){let{data:a,error:i}=yield c.from(l.VISTA_CITAS_ENTERAS).select("*").eq("especialista_id",e);if(i)throw new Error(`Error al obtener citas: ${i.message}`);return this.mapearCitasCompletas(a||[])})}obtenerCitasEspecialista(e,a){return s(this,null,function*(){let i=new Date(`${a}T00:00:00`),r=new Date(`${a}T23:59:59`),{data:o,error:t}=yield c.from(l.CITAS).select(h.FECHA_DURACION).eq("especialista_id",e).neq("estado","cancelado").neq("estado","rechazado").gte("fecha_hora",i.toISOString()).lte("fecha_hora",r.toISOString());return t?(console.error("Error al obtener citas del especialista:",t),[]):o||[]})}obtenerCitasPaciente(e,a){return s(this,null,function*(){let i=new Date(`${a}T00:00:00`),r=new Date(`${a}T23:59:59`),{data:o,error:t}=yield c.from(l.CITAS).select(h.FECHA_DURACION_PARTICIPANTES).eq("paciente_id",e).in("estado",["solicitado","aceptado","realizado","completado"]).gte("fecha_hora",i.toISOString()).lte("fecha_hora",r.toISOString());return t?(console.error("Error al obtener citas del paciente:",t),[]):o||[]})}obtenerCitasCombinadasDia(e,a,i){return s(this,null,function*(){if(!i)return this.obtenerCitasEspecialista(e,a);let r=new Date(`${a}T00:00:00`),o=new Date(`${a}T23:59:59`),{data:t,error:d}=yield c.from(l.CITAS).select(h.FECHA_DURACION_PARTICIPANTES).or(`and(especialista_id.eq.${e},estado.neq.cancelado,estado.neq.rechazado),and(paciente_id.eq.${i},estado.in.(solicitado,aceptado,realizado,completado))`).gte("fecha_hora",r.toISOString()).lte("fecha_hora",o.toISOString());return d?(console.error("Error al obtener citas combinadas:",d),[]):t||[]})}construirBloquesOcupados(e){let a=e.map(i=>{let r=new Date(i.fecha_hora),o=new Date(r.getTime()+i.duracion_min*6e4);return{inicio:r,fin:o}});return a.sort((i,r)=>i.inicio.getTime()-r.inicio.getTime()),a}validarHorarioDisponible(e,a,i){return s(this,null,function*(){let r=a,o=new Date(r.getTime()+i*6e4),{data:t,error:d}=yield c.from(l.CITAS).select(h.FECHA_DURACION).eq("especialista_id",e).neq("estado","cancelado").neq("estado","rechazado").gte("fecha_hora",new Date(r.getTime()-1440*60*1e3).toISOString()).lte("fecha_hora",new Date(o.getTime()+1440*60*1e3).toISOString());if(d)return console.error("Error al validar horario:",d),!1;let u=t||[];for(let m of u){let C=new Date(m.fecha_hora),A=new Date(C.getTime()+m.duracion_min*6e4);if(this.verificarSolapamiento(r,o,C,A))return!1}return!0})}darAltaCita(e){return s(this,null,function*(){try{if(!(yield this.validarHorarioDisponible(e.especialistaId,e.fechaHora,e.duracionMin)))return this.crearRespuestaError("El horario seleccionado ya no est\xE1 disponible. Por favor, elija otro.","horario_no_disponible");let{data:i,error:r}=yield c.from(l.CITAS).insert({fecha_hora:e.fechaHora.toISOString(),duracion_min:e.duracionMin,paciente_id:e.pacienteId,especialista_id:e.especialistaId,especialidad_id:e.especialidadId,estado:e.estado,comentario_paciente:e.comentarioPaciente,comentario_especialista:e.comentarioEspecialista,resenia:e.resenia}).select(h.TODOS_CAMPOS).maybeSingle();return r||!i?(console.error("Error al insertar cita:",r),this.crearRespuestaError("No se pudo registrar la cita",r?.code??"insert_error")):this.crearRespuestaExito("Cita registrada exitosamente",H(P({},e),{fechaHora:new Date(i.fecha_hora)}))}catch(a){return console.error("Excepci\xF3n en darAltaCita:",a),this.crearRespuestaError("Ocurri\xF3 un error inesperado","unexpected_error")}})}static \u0275fac=function(a){return new(a||f)(T(E))};static \u0275prov=g({token:f,factory:f.\u0275fac,providedIn:"root"})};var $=class f{constructor(e,a){this.disponibilidadService=e;this.citasService=a}obtenerEspecialistas(){return s(this,null,function*(){let{data:e,error:a}=yield c.from(l.VISTA_ESPECIALISTAS_FULL).select(q.ESPECIALISTA_ESPECIALIDADES);return a||!e?(console.error("Error al obtener especialistas:",a),[]):e.map(i=>({id:i.especialista_id,nombre:i.nombre,apellido:i.apellido,imagenPerfil:i.url_imagen_perfil,emailVerificado:!0,validadoAdmin:!0,activo:!0}))})}obtenerEspecialistasConDisponibilidad(e=15){return s(this,null,function*(){let a=yield this.obtenerEspecialistas(),i=[];for(let r of a)r.validadoAdmin===!0&&(yield this.especialistaTieneDisponibilidad(r.id,e))&&i.push(r);return i})}obtenerEspecialidadesDeEspecialista(e){return s(this,null,function*(){let{data:a,error:i}=yield c.from(l.VISTA_ESPECIALISTA_ESPECIALIDADES).select(`
          especialista_id,
          especialidad_id,
          nombre_especialidad,
          url_icono,
          duracion_minutos
        `).eq("especialista_id",e);return i||!a?(console.error("Error al obtener especialidades:",i),[]):a.map(r=>({id:r.especialidad_id,nombre:r.nombre_especialidad,icono:r.url_icono,duracion:r.duracion_minutos}))})}obtenerDiasEspecialista(e){return s(this,null,function*(){return this.disponibilidadService.obtenerDiasEspecialista(e)})}calcularFechasDisponibles(r){return s(this,arguments,function*(e,a=15,i=new Date){return this.disponibilidadService.calcularFechasDisponibles(e,a,i)})}obtenerFechasConHorariosDisponibles(t,d){return s(this,arguments,function*(e,a,i=15,r=new Date,o){let u=yield this.disponibilidadService.obtenerTodasDisponibilidades(e);if(u.size===0)return[];let C=(yield this.disponibilidadService.calcularFechasDisponibles(e,i,r)).map(n=>s(this,null,function*(){return(yield this.obtenerHorariosDisponibles(n,e,a,o,u)).length>0?n:null}));return(yield Promise.all(C)).filter(n=>n!==null)})}especialistaTieneDisponibilidad(e,a=15){return s(this,null,function*(){let i=yield this.obtenerEspecialidadesDeEspecialista(e);if(i.length===0)return!1;for(let r of i)if((yield this.obtenerFechasConHorariosDisponibles(e,r.duracion,a)).length>0)return!0;return!1})}obtenerHorariosDisponibles(e,a,i,r,o){return s(this,null,function*(){let t=this.disponibilidadService.calcularDiaSemana(e),d;if(o?d=o.get(t)||null:d=yield this.disponibilidadService.obtenerDisponibilidadDia(a,t),!d)return[];let{hora_inicio:u,hora_fin:m}=d,C=this.disponibilidadService.parseHoraLocal(e,u),A=this.disponibilidadService.parseHoraLocal(e,m),n=yield this.citasService.obtenerCitasCombinadasDia(a,e,r),D=n.filter(p=>p.especialista_id===a||!p.especialista_id),R=r?n.filter(p=>p.paciente_id===r):[],x=this.citasService.construirBloquesOcupados(D),O=[],_=new Date(C);for(let p of x){if(_<p.inicio){let b=new Date(Math.min(p.inicio.getTime(),A.getTime()));_<b&&O.push({inicio:new Date(_),fin:b})}p.fin>_&&(_=new Date(Math.max(_.getTime(),p.fin.getTime())))}_<A&&O.push({inicio:_,fin:A});let w=[];for(let p of O){let b=new Date(p.inicio);for(;b.getTime()+i*6e4<=p.fin.getTime();)w.push(b.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:!1})),b=new Date(b.getTime()+i*6e4)}if(R.length>0){let p=[];for(let b of w){let v=this.disponibilidadService.parseHoraLocal(e,b),U=new Date(v.getTime()+i*6e4),y=!1;for(let N of R){let L=new Date(N.fecha_hora),B=new Date(L.getTime()+N.duracion_min*6e4);if(this.citasService.verificarSolapamiento(v,U,L,B)){y=!0;break}}y||p.push(b)}return p}return w})}darAltaCita(e){return s(this,null,function*(){return this.citasService.darAltaCita(e)})}obtenerCitasConRegistro(){return s(this,null,function*(){return this.citasService.obtenerCitasConRegistro()})}obtenerCitasPaciente(e){return s(this,null,function*(){return this.citasService.obtenerCitasPacienteCompletas(e)})}cancelarCitaPaciente(e,a){return s(this,null,function*(){return this.citasService.actualizarEstadoCita(e.citaId,"cancelado",["completado"],e.estado,"No se puede cancelar un turno ya realizado.","Turno cancelado exitosamente.",{comentario_paciente:a})})}cargarEncuesta(e,a){return s(this,null,function*(){if(e.estado!=="completado")return{success:!1,message:"El turno debe ser realizado para poder cargar encuesta."};if(!e.resenia||e.resenia.trim()==="")return{success:!1,message:"El especialista debe cargar una rese\xF1a antes de poder cargar una encuesta"};let{data:i,error:r}=yield c.from(l.ENCUESTA).insert({id:e.citaId,pregunta1:a.pregunta1,pregunta2:a.pregunta2,pregunta3:a.pregunta3,nombre:a.nombre,telefono:a.telefono}).select().maybeSingle();return r||!i?{success:!1,message:"No se pudo registrar la encuesta",errorCode:r?.code??"insert_error"}:{success:!0,message:"Encuesta registrada exitosamente.",data:!0}})}cargarComentarioAtencion(e,a){return s(this,null,function*(){if(e.estado!=="completado")return{success:!1,message:"El turno debe ser realizado para poder calificar la atencion."};let{error:i}=yield c.from(l.CITAS).update({comentario_paciente:a}).eq("id",e.citaId);return i?{success:!1,message:"No se pudo registrar la calificacion",errorCode:i?.code??"insert_error"}:{success:!0,message:"Atencion calificada exitosamente.",data:!0}})}cancelarCitaEspecialista(e,a){return s(this,null,function*(){return this.citasService.actualizarEstadoCita(e.citaId,"cancelado",["completado","aceptado","rechazado"],e.estado,"No se puede cancelar un turno ya realizado, aceptado o rechazado.","Turno cancelado exitosamente.",{comentario_especialista:a})})}rechazarCitaEspecialista(e,a){return s(this,null,function*(){return this.citasService.actualizarEstadoCita(e.citaId,"rechazado",["completado","aceptado","cancelado"],e.estado,"No se puede rechazar un turno ya realizado, aceptado o cancelado.","Turno rechazado exitosamente.",{comentario_especialista:a})})}aceptarCitaEspecialista(e){return s(this,null,function*(){return this.citasService.actualizarEstadoCita(e.citaId,"aceptado",["completado","rechazado","cancelado"],e.estado,"No se puede aceptar un turno ya realizado, rechazado o cancelado.","Turno aceptado exitosamente.")})}completarCitaEspecialista(e,a){return s(this,null,function*(){return e.estado!=="aceptado"?{success:!1,message:"No se puede finalizar un turno que no fue aceptado."}:this.citasService.actualizarEstadoCita(e.citaId,"completado",[],e.estado,"","Turno completado exitosamente.",{resenia:a})})}obtenerCitasEspecialista(e){return s(this,null,function*(){return this.citasService.obtenerCitasEspecialistaCompletas(e)})}cargarHistoriaClinica(e,a){return s(this,null,function*(){if(a.length<1||a.length>6)return{success:!1,message:"Debe cargar entre 1 y 6 datos m\xE9dicos din\xE1micos"};let{error:i}=yield c.from(l.REGISTROS_MEDICOS).insert({cita_id:e.citaId,altura_cm:e.alturaCm,peso_kg:e.pesoKg,temperatura_c:e.temperaturaC,presion_arterial:e.presionArterial});if(i)return{success:!1,message:"Error al guardar los datos principales de la historia cl\xEDnica"};let r=a.map(t=>({cita_id:e.citaId,clave:t.clave,valor:t.valor})),{error:o}=yield c.from(l.DATOS_MEDICOS_DINAMICOS).insert(r);return o?{success:!1,message:"Error al guardar los datos adicionales de la historia cl\xEDnica"}:{success:!0,message:"Historia cl\xEDnica guardada correctamente"}})}obtenerProximosTurnos(e,a){let i=new Date;return e.filter(r=>new Date(r.fechaHora)>=i&&r.estado==="aceptado").sort((r,o)=>new Date(r.fechaHora).getTime()-new Date(o.fechaHora).getTime()).slice(0,a)}calcularResumenActividad(e){let a=new Date,i=new Date(a.getFullYear(),a.getMonth(),a.getDate()),r=new Date(i.getTime()+1440*60*1e3),o=new Date(a.getFullYear(),a.getMonth(),1),t=new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59),d=e.filter(n=>new Date(n.fechaHora)>=a&&(n.estado==="solicitado"||n.estado==="aceptado")).length,u=e.filter(n=>{let D=new Date(n.fechaHora);return D>=i&&D<r&&n.estado!=="cancelado"&&n.estado!=="rechazado"}).length,m=e.filter(n=>{let D=new Date(n.fechaHora);return D>=o&&D<=t&&n.estado!=="cancelado"&&n.estado!=="rechazado"}).length,C=e.filter(n=>n.estado==="realizado").sort((n,D)=>new Date(D.fechaHora).getTime()-new Date(n.fechaHora).getTime()),A=C.length>0?new Date(C[0].fechaHora):null;return{turnosPendientes:d,turnosHoy:u,turnosMes:m,ultimaActividad:A}}static \u0275fac=function(a){return new(a||f)(T(E),T(I))};static \u0275prov=g({token:f,factory:f.\u0275fac,providedIn:"root"})};export{$ as a};
