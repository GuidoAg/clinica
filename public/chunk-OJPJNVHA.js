import{a as P,b as i}from"./chunk-PAEHXDDS.js";import{T as w,g as v}from"./chunk-ZQYZ5UVW.js";import{a as h,i as c}from"./chunk-ODN5LVDJ.js";function y(a,e){let r=a.split(","),s=r[0].match(/:(.*?);/)?.[1]||"image/png",n=atob(r[1]),o=n.length,t=new Uint8Array(o);for(;o--;)t[o]=n.charCodeAt(o);return new File([t],e,{type:s})}function C(a){return new Promise((e,r)=>{let s=new FileReader;s.onload=()=>{let n=s.result;typeof n=="string"?e(n):r("No se pudo leer el archivo como base64.")},s.onerror=()=>r(s.error),s.readAsDataURL(a)})}function f(a,e,r){return c(this,null,function*(){try{let s=Date.now(),n=`${e}/${r}-${s}.png`,o=y(a,`${r}.png`),{error:t}=yield i.storage.from("imagenes").upload(n,o,{upsert:!0});if(t)return{success:!1,message:"No se pudo subir la imagen."};let{data:l}=i.storage.from("imagenes").getPublicUrl(n);return l?.publicUrl?{success:!0,data:l.publicUrl}:{success:!1,message:"No se pudo obtener la URL p\xFAblica."}}catch{return{success:!1,message:"Error inesperado al subir la imagen."}}})}function U(a,e){return{id:Number(a.id),auth_id:a.auth_id,nombre:a.nombre,apellido:a.apellido,edad:String(a.edad),dni:a.dni,urlImagenPerfil:a.url_imagen_perfil??void 0,emailVerificado:a.email_verificado,rol:a.rol,email:e,obraSocial:a.detalles_paciente?.obra_social??void 0,urlImagenFondo:a.detalles_paciente?.url_imagen_fondo??void 0,validadoAdmin:a.detalles_especialista?.validado_admin,activo:a.detalles_especialista?.activo,especialidades:a.especialista_especialidades?.map(r=>({id:r.especialidades.id,nombre:r.especialidades.nombre,urlIcono:r.especialidades.url_icono??void 0,duracion:r.duracion??void 0}))??[]}}function u(a){if(!a)return"Error desconocido";if(P(a))switch(a.code){case"invalid_credentials":return"Email o contrase\xF1a incorrectos.";case"email_not_confirmed":return"Debes verificar tu email antes de poder ingresar.";case"user_already_exists":case"email_exists":return"Ya existe una cuenta registrada con este email.";case"email_address_invalid":return"El email ingresado no es v\xE1lido.";case"unexpected_failure":return"Ha ocurrido un error inesperado. Intente m\xE1s tarde.";case"especialista_no_validado":return"Tu cuenta a\xFAn no fue validada por un administrador.";default:return"Error desconocido. Intente nuevamente."}return"Error desconocido"}var S=class a{userSubject=new v(null);user$=this.userSubject.asObservable();constructor(){this.restoreUserFromSession()}getCurrentUser(){return this.userSubject.getValue()}setCurrentUser(e){this.userSubject.next(e)}updateCurrentUser(e){let r=this.getCurrentUser();r&&this.userSubject.next(h(h({},r),e))}recargarUsuario(){return c(this,null,function*(){let e=this.getCurrentUser();e&&(yield this.loadUsuarioDesdePerfil(e.auth_id,e.email))})}getAvatarUrl(e){return i.storage.from("imagenes").getPublicUrl(e).data.publicUrl}restoreUserFromSession(){return c(this,null,function*(){let{data:e,error:r}=yield i.auth.getUser();if(r?.message==="User from sub claim in JWT does not exist"){yield i.auth.signOut(),localStorage.clear(),sessionStorage.clear(),this.userSubject.next(null);return}if(!e.user||!e.user.id){this.userSubject.next(null);return}yield this.loadUsuarioDesdePerfil(e.user.id,e.user.email??"")})}loadUsuarioDesdePerfil(e,r){return c(this,null,function*(){if(!e)return this.userSubject.next(null),{success:!1};let{data:s,error:n}=yield i.from("perfiles").select(`
        id,
        auth_id,
        nombre,
        apellido,
        edad,
        dni,
        url_imagen_perfil,
        email_verificado,
        rol,
        detalles_paciente (
          obra_social,
          url_imagen_fondo
        ),
        detalles_especialista (
          validado_admin,
          activo
        ),
        especialista_especialidades (
        duracion,
          especialidades (
            id,
            nombre,
            url_icono
          )
        )
      `).eq("auth_id",e).maybeSingle();if(n||!s)return this.userSubject.next(null),{success:!1};let o=U(s,r);if(o.rol==="especialista"&&!o.validadoAdmin)return this.userSubject.next(null),{success:!1,errorCode:"Tu cuenta a\xFAn no fue validada por un administrador"};if(!o.emailVerificado){let{error:t}=yield i.from("perfiles").update({email_verificado:!0}).eq("auth_id",e);if(t)return console.error("Error al actualizar email_verificado:",t),{success:!1,errorCode:"No se pudo actualizar el estado de verificaci\xF3n del email"};o.emailVerificado=!0}return this.userSubject.next(o),{success:!0}})}login(e,r){return c(this,null,function*(){let{data:s,error:n}=yield i.auth.signInWithPassword({email:e,password:r});if(n||!s.user)return{success:!1,errorCode:u(n),message:n?.message??"Error desconocido al iniciar sesi\xF3n"};let o=yield this.loadUsuarioDesdePerfil(s.user.id,s.user.email??"");return o.success==!1?o:{success:!0}})}logout(){return c(this,null,function*(){yield i.auth.signOut(),this.userSubject.next(null)})}registerPaciente(e){return c(this,null,function*(){let{data:r,error:s}=yield i.auth.signUp({email:e.mail,password:e.contrasena});if(r?.user?.identities?.length===0)return{success:!1,errorCode:u(s),message:"Ya existe una cuenta registrada con este email."};if(s||!r.user)return{success:!1,errorCode:u(s),message:s?.message??"Error desconocido al registrar"};let n=r.user.id,o=e.nombre.replace(/\s+/g,""),t=yield f(e.imagenPerfil,"fotoPerfilPaciente",`perfil-${o}`);if(!t.success||!t.data)return{success:!1,message:t.message};let l=yield f(e.imagenFondo,"fotoFondoPaciente",`fondo-${o}`);if(!l.success||!l.data)return{success:!1,message:l.message};let{data:d,error:m}=yield i.from("perfiles").insert({auth_id:n,nombre:e.nombre,apellido:e.apellido,edad:parseInt(e.edad,10),dni:e.dni,url_imagen_perfil:t.data,rol:"paciente"}).select("id").single();if(m||!d)return{success:!1,message:"Error al guardar el perfil del usuario."};let{error:p}=yield i.from("detalles_paciente").insert({perfil_id:d.id,obra_social:e.obraSocial,url_imagen_fondo:l.data});return p?{success:!1,message:"Error al guardar la obra social del paciente."}:{success:!0}})}registerEspecialista(e){return c(this,null,function*(){let{data:r,error:s}=yield i.auth.signUp({email:e.mail,password:e.contrasena});if(r?.user?.identities?.length===0)return{success:!1,errorCode:u(s),message:"Ya existe una cuenta registrada con este email."};if(s||!r.user)return{success:!1,errorCode:u(s),message:s?.message??"Error desconocido al iniciar sesi\xF3n"};let n=r.user.id,o=e.nombre.replace(/\s+/g,""),t=yield f(e.imagenPerfil,"fotoPerfilEspecialista",`perfil-${o}`);if(!t.success||!t.data)return{success:!1,message:t.message};let{data:l,error:d}=yield i.from("perfiles").insert({auth_id:n,nombre:e.nombre,apellido:e.apellido,edad:parseInt(e.edad,10),dni:e.dni,url_imagen_perfil:t.data,rol:"especialista"}).select("id").single();if(d||!l)return{success:!1,message:"Error al guardar el perfil del especialista."};let{error:m}=yield i.from("detalles_especialista").insert({perfil_id:l.id,validado_admin:!1,activo:!0});if(m)return{success:!1,message:"Error al guardar los detalles del especialista."};let p=[];for(let g of e.especialidades){let E=Number(g),x=!Number.isInteger(E),_;if(x){let b=yield this.agregarEspecialidadSiNoExiste(String(g));if(!b.success||!b.data)return{success:!1,message:b.message};_=b.data}else _=E;p.push({perfil_id:l.id,especialidad_id:_,duracion:30})}if(p.length>0){let{error:g}=yield i.from("especialista_especialidades").insert(p);if(g)return{success:!1,message:"Error al asignar las especialidades al especialista."}}return{success:!0}})}registerAdmin(e){return c(this,null,function*(){let{data:r,error:s}=yield i.auth.signUp({email:e.mail,password:e.contrasena});if(r?.user?.identities?.length===0)return{success:!1,errorCode:u(s),message:"Ya existe una cuenta registrada con este email."};if(s||!r.user)return{success:!1,errorCode:u(s),message:s?.message??"Error desconocido al iniciar sesi\xF3n"};let n=r.user.id,o=e.nombre.replace(/\s+/g,""),t=yield f(e.imagenPerfil,"fotoPerfilAdmin",`perfil-${o}`);if(!t.success||!t.data)return{success:!1,message:t.message};let{error:l}=yield i.from("perfiles").insert({auth_id:n,nombre:e.nombre,apellido:e.apellido,edad:parseInt(e.edad,10),dni:e.dni,url_imagen_perfil:t.data,rol:"admin"});return l?{success:!1,message:"Error al guardar el perfil del admin."}:{success:!0}})}obtenerEspecialidades(){return c(this,null,function*(){let{data:e,error:r}=yield i.from("especialidades").select("id, nombre, url_icono").order("nombre",{ascending:!0});return r||!e?(console.error("Error al obtener especialidades:",r),[]):e.map(s=>({id:s.id,nombre:s.nombre,urlIcono:s.url_icono??void 0}))})}agregarEspecialidadSiNoExiste(e){return c(this,null,function*(){let r=e.trim().toLowerCase(),{data:s,error:n}=yield i.from("especialidades").select("id, nombre").ilike("nombre",r);if(n)return{success:!1,message:"Error al buscar especialidades existentes"};if(s?.some(m=>m.nombre.trim().toLowerCase()===r)&&s?.[0]?.id)return{success:!0,data:s[0].id};let t="https://rtcjwvxzoxhglvqirrel.supabase.co/storage/v1/object/public/imagenes/fotoEspecialidad/default.png",{data:l,error:d}=yield i.from("especialidades").insert({nombre:e,url_icono:t}).select("id").single();return d||!l?.id?{success:!1,message:"Error al insertar nueva especialidad."}:{success:!0,data:l.id}})}getCaptchas(){return c(this,null,function*(){let{data:e,error:r}=yield i.from("captcha").select("imagenUrl, respuesta").overrideTypes();return console.log(e),r||!e?(console.error("Error al obtener captchas:",r),[]):e.map(s=>({imagenUrl:s.imagenUrl,answerHash:s.respuesta}))})}registrarIngreso(e){return c(this,null,function*(){let{error:r}=yield i.from("registro_ingresos").insert({perfil_id:e});r&&console.error("Error al registrar el ingreso:",r.message)})}static \u0275fac=function(r){return new(r||a)};static \u0275prov=w({token:a,factory:a.\u0275fac,providedIn:"root"})};export{C as a,S as b};
