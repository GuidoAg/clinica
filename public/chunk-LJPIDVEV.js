import{b as l,c as d,d as P,e as I,f as $,g as x}from"./chunk-Z4223MVF.js";import{U as S,Y as w}from"./chunk-JXJDPNLJ.js";import{a as y,b as F,j as s}from"./chunk-K4ALXBGI.js";var N=(o=>(o.SOLICITADO="solicitado",o.ACEPTADO="aceptado",o.RECHAZADO="rechazado",o.CANCELADO="cancelado",o.COMPLETADO="completado",o))(N||{});var O=class h{DIAS_SEMANA_NUMERO_A_NOMBRE={1:"lunes",2:"martes",3:"mi\xE9rcoles",4:"jueves",5:"viernes",6:"s\xE1bado",7:"domingo"};DIAS_SEMANA_NOMBRE_A_NUMERO={lunes:1,martes:2,mi\u00E9rcoles:3,jueves:4,viernes:5,s\u00E1bado:6,domingo:0};obtenerDiasEspecialista(e){return s(this,null,function*(){let{data:i,error:a}=yield l.from(d.DISPONIBILIDADES).select(P.DIA_SEMANA).eq("perfil_id",e).eq("habilitado",!0);return a||!i?(console.error("Error al obtener d\xEDas disponibles:",a),[]):i.map(o=>this.DIAS_SEMANA_NUMERO_A_NOMBRE[o.dia_semana]).filter((o,r,n)=>o&&n.indexOf(o)===r)})}calcularFechasDisponibles(t){return s(this,arguments,function*(e,i=15,a=new Date){let o=yield this.obtenerDiasEspecialista(e);if(o.length===0)return[];let r=o.map(u=>this.DIAS_SEMANA_NOMBRE_A_NUMERO[u.toLowerCase()]),n=[];for(let u=0;u<i;u++){let c=new Date(a);c.setDate(c.getDate()+u);let b=c.getDay();r.includes(b)&&n.push(this.formatearFecha(c))}return n})}obtenerTodasDisponibilidades(e){return s(this,null,function*(){let{data:i,error:a}=yield l.from(d.DISPONIBILIDADES).select(P.DIA_HORA_INICIO_FIN).eq("perfil_id",e).eq("habilitado",!0);if(a||!i)return new Map;let t=new Map;for(let o of i)t.set(o.dia_semana,{hora_inicio:o.hora_inicio,hora_fin:o.hora_fin});return t})}obtenerDisponibilidadDia(e,i){return s(this,null,function*(){let{data:a,error:t}=yield l.from(d.DISPONIBILIDADES).select(P.DIA_HORA_INICIO_FIN).eq("perfil_id",e).eq("dia_semana",i).eq("habilitado",!0).maybeSingle();return t||!a?null:a})}tieneDisponibilidadConfigurada(e){return s(this,null,function*(){let{data:i,error:a}=yield l.from(d.DISPONIBILIDADES).select(P.SOLO_ID).eq("perfil_id",e).eq("habilitado",!0).limit(1);return!a&&i&&i.length>0})}parseHoraLocal(e,i){let[a,t,o]=e.split("-").map(Number),[r,n]=i.split(":").map(Number);return new Date(a,t-1,o,r,n)}formatearFecha(e){let i=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),t=String(e.getDate()).padStart(2,"0");return`${i}-${a}-${t}`}formatearHora(e){return e.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:!1})}calcularDiaSemana(e){let[i,a,t]=e.split("-").map(Number);return(new Date(i,a-1,t).getDay()+6)%7+1}crearRangoDia(e){return{inicio:new Date(`${e}T00:00:00`),fin:new Date(`${e}T23:59:59`)}}static \u0275fac=function(i){return new(i||h)};static \u0275prov=S({token:h,factory:h.\u0275fac,providedIn:"root"})};var R=class h{constructor(e){this.disponibilidadService=e}crearRespuestaError(e,i){return{success:!1,message:e,errorCode:i}}crearRespuestaExito(e,i){return{success:!0,message:e,data:i}}verificarSolapamiento(e,i,a,t){return e<t&&i>a}actualizarEstadoCita(e,i,a,t,o,r,n){return s(this,null,function*(){if(a.includes(t))return this.crearRespuestaError(o);let u=y({estado:i},n),{error:c}=yield l.from(d.CITAS).update(u).eq("id",e);return c?this.crearRespuestaError("Ocurri\xF3 un error al actualizar el turno.",c.code):this.crearRespuestaExito(r,!0)})}mapearCitasCompletas(e){return s(this,null,function*(){if(!e||e.length===0)return[];let i=e.map(r=>r.cita_id),{data:a,error:t}=yield l.from(d.DATOS_MEDICOS_DINAMICOS).select($.TODOS_CAMPOS).in("cita_id",i);if(t)throw new Error(`Error al obtener datos din\xE1micos: ${t.message}`);let o={};for(let r of a||[])r.cita_id&&(o[r.cita_id]||(o[r.cita_id]=[]),o[r.cita_id].push({id:r.id,clave:r.clave,valor:r.valor,citaId:r.cita_id}));return e.map(r=>({citaId:r.cita_id,fechaHora:new Date(r.fecha_hora),duracionMin:r.duracion_min,estado:r.estado,comentarioPaciente:r.comentario_paciente??"",comentarioEspecialista:r.comentario_especialista??"",resenia:r.resenia??"",pacienteId:r.paciente_id,pacienteNombreCompleto:r.paciente_nombre_completo,especialistaId:r.especialista_id,especialistaNombreCompleto:r.especialista_nombre_completo,especialidadId:r.especialidad_id,especialidadNombre:r.especialidad_nombre,alturaCm:Number(r.altura_cm),pesoKg:Number(r.peso_kg),temperaturaC:Number(r.temperatura_c),presionArterial:r.presion_arterial??"",datosDinamicos:o[r.cita_id]||[]}))})}obtenerCitasConRegistro(){return s(this,null,function*(){let{data:e,error:i}=yield l.from(d.VISTA_CITAS_ENTERAS).select("*");if(i)throw new Error(`Error al obtener citas: ${i.message}`);return this.mapearCitasCompletas(e||[])})}obtenerCitasPacienteCompletas(e){return s(this,null,function*(){let{data:i,error:a}=yield l.from(d.VISTA_CITAS_ENTERAS).select("*").eq("paciente_id",e);if(a)throw new Error(`Error al obtener citas: ${a.message}`);return this.mapearCitasCompletas(i||[])})}obtenerCitasEspecialistaCompletas(e){return s(this,null,function*(){let{data:i,error:a}=yield l.from(d.VISTA_CITAS_ENTERAS).select("*").eq("especialista_id",e);if(a)throw new Error(`Error al obtener citas: ${a.message}`);return this.mapearCitasCompletas(i||[])})}obtenerCitasEspecialista(e,i){return s(this,null,function*(){let a=new Date(`${i}T00:00:00`),t=new Date(`${i}T23:59:59`),{data:o,error:r}=yield l.from(d.CITAS).select(I.FECHA_DURACION).eq("especialista_id",e).neq("estado","cancelado").neq("estado","rechazado").gte("fecha_hora",a.toISOString()).lte("fecha_hora",t.toISOString());return r?(console.error("Error al obtener citas del especialista:",r),[]):o||[]})}obtenerCitasPaciente(e,i){return s(this,null,function*(){let a=new Date(`${i}T00:00:00`),t=new Date(`${i}T23:59:59`),{data:o,error:r}=yield l.from(d.CITAS).select(I.FECHA_DURACION_PARTICIPANTES).eq("paciente_id",e).in("estado",["solicitado","aceptado","completado"]).gte("fecha_hora",a.toISOString()).lte("fecha_hora",t.toISOString());return r?(console.error("Error al obtener citas del paciente:",r),[]):o||[]})}obtenerCitasCombinadasDia(e,i,a){return s(this,null,function*(){if(!a)return this.obtenerCitasEspecialista(e,i);let t=new Date(`${i}T00:00:00`),o=new Date(`${i}T23:59:59`),{data:r,error:n}=yield l.from(d.CITAS).select(I.FECHA_DURACION_PARTICIPANTES).or(`and(especialista_id.eq.${e},estado.neq.cancelado,estado.neq.rechazado),and(paciente_id.eq.${a},estado.in.(solicitado,aceptado,completado))`).gte("fecha_hora",t.toISOString()).lte("fecha_hora",o.toISOString());return n?(console.error("Error al obtener citas combinadas:",n),[]):r||[]})}construirBloquesOcupados(e){let i=e.map(a=>{let t=new Date(a.fecha_hora),o=new Date(t.getTime()+a.duracion_min*6e4);return{inicio:t,fin:o}});return i.sort((a,t)=>a.inicio.getTime()-t.inicio.getTime()),i}validarHorarioDisponible(e,i,a){return s(this,null,function*(){let t=i,o=new Date(t.getTime()+a*6e4),{data:r,error:n}=yield l.from(d.CITAS).select(I.FECHA_DURACION).eq("especialista_id",e).neq("estado","cancelado").neq("estado","rechazado").gte("fecha_hora",new Date(t.getTime()-1440*60*1e3).toISOString()).lte("fecha_hora",new Date(o.getTime()+1440*60*1e3).toISOString());if(n)return console.error("Error al validar horario:",n),!1;let u=r||[];for(let c of u){let b=new Date(c.fecha_hora),A=new Date(b.getTime()+c.duracion_min*6e4);if(this.verificarSolapamiento(t,o,b,A))return!1}return!0})}darAltaCita(e){return s(this,null,function*(){try{if(!(yield this.validarHorarioDisponible(e.especialistaId,e.fechaHora,e.duracionMin)))return this.crearRespuestaError("El horario seleccionado ya no est\xE1 disponible. Por favor, elija otro.","horario_no_disponible");let{data:a,error:t}=yield l.from(d.CITAS).insert({fecha_hora:e.fechaHora.toISOString(),duracion_min:e.duracionMin,paciente_id:e.pacienteId,especialista_id:e.especialistaId,especialidad_id:e.especialidadId,estado:e.estado,comentario_paciente:e.comentarioPaciente,comentario_especialista:e.comentarioEspecialista,resenia:e.resenia}).select(I.TODOS_CAMPOS).maybeSingle();return t||!a?(console.error("Error al insertar cita:",t),this.crearRespuestaError("No se pudo registrar la cita",t?.code??"insert_error")):this.crearRespuestaExito("Cita registrada exitosamente",F(y({},e),{fechaHora:new Date(a.fecha_hora)}))}catch(i){return console.error("Excepci\xF3n en darAltaCita:",i),this.crearRespuestaError("Ocurri\xF3 un error inesperado","unexpected_error")}})}static \u0275fac=function(i){return new(i||h)(w(O))};static \u0275prov=S({token:h,factory:h.\u0275fac,providedIn:"root"})};var U=class h{constructor(e,i){this.disponibilidadService=e;this.citasService=i}cacheDisponibilidad=new Map;CACHE_TTL=60*1e3;obtenerEspecialistas(){return s(this,null,function*(){let{data:e,error:i}=yield l.from(d.VISTA_ESPECIALISTAS_FULL).select(x.ESPECIALISTA_ESPECIALIDADES);return i||!e?(console.error("Error al obtener especialistas:",i),[]):e.map(a=>({id:a.especialista_id,nombre:a.nombre,apellido:a.apellido,imagenPerfil:a.url_imagen_perfil,emailVerificado:!0,validadoAdmin:!0,activo:!0}))})}obtenerEspecialistasConDisponibilidad(e=15){return s(this,null,function*(){let i=yield this.obtenerEspecialistas(),a=[];for(let t of i)t.validadoAdmin===!0&&(yield this.especialistaTieneDisponibilidad(t.id,e))&&a.push(t);return a})}obtenerEspecialidadesDeEspecialista(e){return s(this,null,function*(){let{data:i,error:a}=yield l.from(d.VISTA_ESPECIALISTA_ESPECIALIDADES).select(`
          especialista_id,
          especialidad_id,
          nombre_especialidad,
          url_icono,
          duracion_minutos
        `).eq("especialista_id",e);return a||!i?(console.error("Error al obtener especialidades:",a),[]):i.map(t=>({id:t.especialidad_id,nombre:t.nombre_especialidad,icono:t.url_icono,duracion:t.duracion_minutos}))})}obtenerDiasEspecialista(e){return s(this,null,function*(){return this.disponibilidadService.obtenerDiasEspecialista(e)})}calcularFechasDisponibles(t){return s(this,arguments,function*(e,i=15,a=new Date){return this.disponibilidadService.calcularFechasDisponibles(e,i,a)})}obtenerFechasConHorariosDisponibles(r,n){return s(this,arguments,function*(e,i,a=15,t=new Date,o){let u=`${e}-${i}-${t.toISOString().split("T")[0]}-${o||"sin-paciente"}`,c=this.cacheDisponibilidad.get(u);if(c&&Date.now()-c.timestamp<this.CACHE_TTL)return c.data;let b=yield this.disponibilidadService.obtenerTodasDisponibilidades(e);if(b.size===0)return[];let m=(yield this.disponibilidadService.calcularFechasDisponibles(e,a,t)).map(C=>s(this,null,function*(){return(yield this.obtenerHorariosDisponibles(C,e,i,o,b)).length>0?C:null})),E=(yield Promise.all(m)).filter(C=>C!==null);return this.cacheDisponibilidad.set(u,{data:E,timestamp:Date.now()}),E})}obtenerFechasConHorariosDisponiblesProgresivo(e,i,a,t=7,o=15){return s(this,null,function*(){let r=new Date,n=`${e}-${i}-${r.toISOString().split("T")[0]}-${a||"sin-paciente"}`,u=this.cacheDisponibilidad.get(n);if(u&&Date.now()-u.timestamp<this.CACHE_TTL)return{inicial:u.data.slice(0,t),completar:()=>s(this,null,function*(){return u.data})};let c=yield this.disponibilidadService.obtenerTodasDisponibilidades(e);if(c.size===0)return{inicial:[],completar:()=>s(this,null,function*(){return[]})};let A=(yield this.disponibilidadService.calcularFechasDisponibles(e,t,r)).map(C=>s(this,null,function*(){return(yield this.obtenerHorariosDisponibles(C,e,i,a,c)).length>0?C:null})),f=(yield Promise.all(A)).filter(C=>C!==null);return{inicial:f,completar:()=>s(this,null,function*(){let _=(yield this.disponibilidadService.calcularFechasDisponibles(e,o,r)).slice(t).map(g=>s(this,null,function*(){return(yield this.obtenerHorariosDisponibles(g,e,i,a,c)).length>0?g:null})),p=(yield Promise.all(_)).filter(g=>g!==null),D=[...f,...p];return this.cacheDisponibilidad.set(n,{data:D,timestamp:Date.now()}),D})}})}invalidarCacheDisponibilidad(e){if(!e){this.cacheDisponibilidad.clear();return}let i=[];this.cacheDisponibilidad.forEach((a,t)=>{t.startsWith(`${e}-`)&&i.push(t)}),i.forEach(a=>this.cacheDisponibilidad.delete(a))}especialistaTieneDisponibilidad(e,i=15){return s(this,null,function*(){let a=yield this.obtenerEspecialidadesDeEspecialista(e);if(a.length===0)return!1;for(let t of a)if((yield this.obtenerFechasConHorariosDisponibles(e,t.duracion,i)).length>0)return!0;return!1})}obtenerHorariosDisponibles(e,i,a,t,o){return s(this,null,function*(){let r=this.disponibilidadService.calcularDiaSemana(e),n;if(o?n=o.get(r)||null:n=yield this.disponibilidadService.obtenerDisponibilidadDia(i,r),!n)return[];let{hora_inicio:u,hora_fin:c}=n,b=this.disponibilidadService.parseHoraLocal(e,u),A=this.disponibilidadService.parseHoraLocal(e,c),m=yield this.citasService.obtenerCitasCombinadasDia(i,e,t),f=m.filter(p=>p.especialista_id===i||!p.especialista_id),E=t?m.filter(p=>p.paciente_id===t):[],C=this.citasService.construirBloquesOcupados(f),T=[],_=new Date(b);for(let p of C){if(_<p.inicio){let D=new Date(Math.min(p.inicio.getTime(),A.getTime()));_<D&&T.push({inicio:new Date(_),fin:D})}p.fin>_&&(_=new Date(Math.max(_.getTime(),p.fin.getTime())))}_<A&&T.push({inicio:_,fin:A});let v=[];for(let p of T){let D=new Date(p.inicio);for(;D.getTime()+a*6e4<=p.fin.getTime();)v.push(D.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:!1})),D=new Date(D.getTime()+a*6e4)}if(E.length>0){let p=[];for(let D of v){let g=this.disponibilidadService.parseHoraLocal(e,D),H=new Date(g.getTime()+a*6e4),L=!1;for(let M of E){let q=new Date(M.fecha_hora),j=new Date(q.getTime()+M.duracion_min*6e4);if(this.citasService.verificarSolapamiento(g,H,q,j)){L=!0;break}}L||p.push(D)}return p}return v})}darAltaCita(e){return s(this,null,function*(){let i=yield this.citasService.darAltaCita(e);return i.success&&this.invalidarCacheDisponibilidad(e.especialistaId),i})}obtenerCitasConRegistro(){return s(this,null,function*(){return this.citasService.obtenerCitasConRegistro()})}obtenerCitasPaciente(e){return s(this,null,function*(){return this.citasService.obtenerCitasPacienteCompletas(e)})}cancelarCitaPaciente(e,i){return s(this,null,function*(){let a=yield this.citasService.actualizarEstadoCita(e.citaId,"cancelado",["completado"],e.estado,"No se puede cancelar un turno ya completado.","Turno cancelado exitosamente.",{comentario_paciente:i});return a.success&&this.invalidarCacheDisponibilidad(e.especialistaId),a})}cargarComentarioAtencion(e,i){return s(this,null,function*(){if(e.estado!=="completado")return{success:!1,message:"El turno debe ser completado para poder calificar la atencion."};let{error:a}=yield l.from(d.CITAS).update({comentario_paciente:i}).eq("id",e.citaId);return a?{success:!1,message:"No se pudo registrar la calificacion",errorCode:a?.code??"insert_error"}:{success:!0,message:"Atencion calificada exitosamente.",data:!0}})}cancelarCitaEspecialista(e,i){return s(this,null,function*(){let a=yield this.citasService.actualizarEstadoCita(e.citaId,"cancelado",["completado","aceptado","rechazado"],e.estado,"No se puede cancelar un turno ya completado, aceptado o rechazado.","Turno cancelado exitosamente.",{comentario_especialista:i});return a.success&&this.invalidarCacheDisponibilidad(e.especialistaId),a})}rechazarCitaEspecialista(e,i){return s(this,null,function*(){return this.citasService.actualizarEstadoCita(e.citaId,"rechazado",["completado","aceptado","cancelado"],e.estado,"No se puede rechazar un turno ya completado, aceptado o cancelado.","Turno rechazado exitosamente.",{comentario_especialista:i})})}aceptarCitaEspecialista(e){return s(this,null,function*(){return this.citasService.actualizarEstadoCita(e.citaId,"aceptado",["completado","rechazado","cancelado"],e.estado,"No se puede aceptar un turno ya completado, rechazado o cancelado.","Turno aceptado exitosamente.")})}completarCitaEspecialista(e,i){return s(this,null,function*(){return e.estado!=="aceptado"?{success:!1,message:"No se puede finalizar un turno que no fue aceptado."}:this.citasService.actualizarEstadoCita(e.citaId,"completado",[],e.estado,"","Turno completado exitosamente.",{resenia:i})})}obtenerCitasEspecialista(e){return s(this,null,function*(){return this.citasService.obtenerCitasEspecialistaCompletas(e)})}cargarHistoriaClinica(e,i){return s(this,null,function*(){if(i.length<1||i.length>6)return{success:!1,message:"Debe cargar entre 1 y 6 datos m\xE9dicos din\xE1micos"};let{error:a}=yield l.from(d.REGISTROS_MEDICOS).insert({cita_id:e.citaId,altura_cm:e.alturaCm,peso_kg:e.pesoKg,temperatura_c:e.temperaturaC,presion_arterial:e.presionArterial});if(a)return{success:!1,message:"Error al guardar los datos principales de la historia cl\xEDnica"};let t=i.map(r=>({cita_id:e.citaId,clave:r.clave,valor:r.valor})),{error:o}=yield l.from(d.DATOS_MEDICOS_DINAMICOS).insert(t);return o?{success:!1,message:"Error al guardar los datos adicionales de la historia cl\xEDnica"}:{success:!0,message:"Historia cl\xEDnica guardada correctamente"}})}obtenerProximosTurnos(e,i){let a=new Date;return e.filter(t=>new Date(t.fechaHora)>=a&&t.estado==="aceptado").sort((t,o)=>new Date(t.fechaHora).getTime()-new Date(o.fechaHora).getTime()).slice(0,i)}calcularResumenActividad(e){let i=new Date,a=new Date(i.getFullYear(),i.getMonth(),i.getDate()),t=new Date(a.getTime()+1440*60*1e3),o=new Date(i.getFullYear(),i.getMonth(),1),r=new Date(i.getFullYear(),i.getMonth()+1,0,23,59,59),n=e.filter(m=>new Date(m.fechaHora)>=i&&(m.estado==="solicitado"||m.estado==="aceptado")).length,u=e.filter(m=>{let f=new Date(m.fechaHora);return f>=a&&f<t&&m.estado!=="cancelado"&&m.estado!=="rechazado"}).length,c=e.filter(m=>{let f=new Date(m.fechaHora);return f>=o&&f<=r&&m.estado!=="cancelado"&&m.estado!=="rechazado"}).length,b=e.filter(m=>m.estado==="completado").sort((m,f)=>new Date(f.fechaHora).getTime()-new Date(m.fechaHora).getTime()),A=b.length>0?new Date(b[0].fechaHora):null;return{turnosPendientes:n,turnosHoy:u,turnosMes:c,ultimaActividad:A}}static \u0275fac=function(i){return new(i||h)(w(O),w(R))};static \u0275prov=S({token:h,factory:h.\u0275fac,providedIn:"root"})};export{N as a,U as b};
