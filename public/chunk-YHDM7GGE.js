import{a as n}from"./chunk-NSHH6JJ5.js";import{U as v}from"./chunk-7RTQA4J5.js";import{a as P,b as y,i as c}from"./chunk-ODN5LVDJ.js";var N=class C{obtenerEspecialistas(){return c(this,null,function*(){let{data:e,error:a}=yield n.from("vista_perfiles_con_email").select(`
      id,
      auth_id,
      nombre,
      apellido,
      edad,
      dni,
      url_imagen_perfil, 
      rol,
      email,
      email_verificado_real,
      detalles_paciente (
        obra_social,
        url_imagen_fondo
      ),
      detalles_especialista (
        validado_admin,
        activo
      ),
      especialista_especialidades (
        duracion,
        especialidades (
          id,
          nombre,
          url_icono
        )
      )
    `).eq("rol","especialista").eq("email_verificado_real",!0);return a||!e?(console.error("Error al obtener usuarios:",a),[]):e.map(r=>{let o=Array.isArray(r.detalles_especialista)?r.detalles_especialista[0]:r.detalles_especialista??null;return{id:r.id,nombre:r.nombre,apellido:r.apellido,imagenPerfil:r.url_imagen_perfil,emailVerificado:r.email_verificado_real??!1,validadoAdmin:o?.validado_admin??!1,activo:o.activo??!1}})})}obtenerEspecialistasConDisponibilidad(e=15){return c(this,null,function*(){let a=yield this.obtenerEspecialistas(),r=[];for(let o of a)o.validadoAdmin===!0&&(yield this.especialistaTieneDisponibilidad(o.id,e))&&r.push(o);return r})}obtenerEspecialidadesDeEspecialista(e){return c(this,null,function*(){let{data:a,error:r}=yield n.from("vista_especialista_especialidades").select(`
          especialista_id,
          especialidad_id,
          nombre_especialidad,
          url_icono,
          duracion_minutos
        `).eq("especialista_id",e);return r||!a?(console.error("Error al obtener usuarios:",r),[]):a.map(o=>({id:o.especialidad_id,nombre:o.nombre_especialidad,icono:o.url_icono,duracion:o.duracion_minutos}))})}obtenerDiasEspecialista(e){return c(this,null,function*(){let{data:a,error:r}=yield n.from("disponibilidades").select("dia_semana").eq("perfil_id",e).eq("habilitado",!0);if(r||!a)return console.error("Error al obtener d\xEDas disponibles:",r),[];let o={1:"lunes",2:"martes",3:"mi\xE9rcoles",4:"jueves",5:"viernes",6:"s\xE1bado",7:"domingo"};return a.map(s=>o[s.dia_semana]).filter((s,i,_)=>s&&_.indexOf(s)===i)})}calcularFechasDisponibles(o){return c(this,arguments,function*(e,a=15,r=new Date){let t=yield this.obtenerDiasEspecialista(e),s={lunes:1,martes:2,mi\u00E9rcoles:3,jueves:4,viernes:5,s\u00E1bado:6,domingo:0},i=t.map(m=>s[m.toLowerCase()]),_=[];for(let m=0;m<a;m++){let p=new Date(r);p.setDate(p.getDate()+m);let g=p.getDay();if(i.includes(g)){let l=p.getFullYear(),f=String(p.getMonth()+1).padStart(2,"0"),D=String(p.getDate()).padStart(2,"0");_.push(`${l}-${f}-${D}`)}}return _})}obtenerFechasConHorariosDisponibles(t,s){return c(this,arguments,function*(e,a,r=15,o=new Date){let i=yield this.calcularFechasDisponibles(e,r,o),_=[];for(let m of i)(yield this.obtenerHorariosDisponibles(m,e,a)).length>0&&_.push(m);return _})}especialistaTieneDisponibilidad(e,a=15){return c(this,null,function*(){let r=yield this.obtenerEspecialidadesDeEspecialista(e);if(r.length===0)return!1;for(let o of r)if((yield this.obtenerFechasConHorariosDisponibles(e,o.duracion,a)).length>0)return!0;return!1})}obtenerHorariosDisponibles(e,a,r){return c(this,null,function*(){let[o,t,s]=e.split("-").map(Number),_=(new Date(o,t-1,s).getDay()+6)%7+1,{data:m,error:p}=yield n.from("disponibilidades").select("hora_inicio, hora_fin").eq("perfil_id",a).eq("dia_semana",_).eq("habilitado",!0).maybeSingle();if(p||!m)return console.error("Sin disponibilidad:",p),[];let{hora_inicio:g,hora_fin:l}=m;function f(d,u){let[T,M,L]=d.split("-").map(Number),[q,S]=u.split(":").map(Number);return new Date(T,M-1,L,q,S)}let D=f(e,g),h=f(e,l),I=new Date(`${e}T00:00:00`),H=new Date(`${e}T23:59:59`),{data:R,error:E}=yield n.from("citas").select("fecha_hora, duracion_min").eq("especialista_id",a).neq("estado","cancelado").neq("estado","rechazado").gte("fecha_hora",I.toISOString()).lte("fecha_hora",H.toISOString());if(E)return console.error("Error al obtener citas:",E),[];let w=(R||[]).map(d=>{let u=new Date(d.fecha_hora),T=new Date(u.getTime()+d.duracion_min*6e4);return{inicio:u,fin:T}});w.sort((d,u)=>d.inicio.getTime()-u.inicio.getTime());let A=[],b=new Date(D);for(let d of w){if(b<d.inicio){let u=new Date(Math.min(d.inicio.getTime(),h.getTime()));b<u&&A.push({inicio:new Date(b),fin:u})}d.fin>b&&(b=new Date(Math.max(b.getTime(),d.fin.getTime())))}b<h&&A.push({inicio:b,fin:h});let O=[];for(let d of A){let u=new Date(d.inicio);for(;u.getTime()+r*6e4<=d.fin.getTime();)O.push(u.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:!1})),u=new Date(u.getTime()+r*6e4)}return O})}darAltaCita(e){return c(this,null,function*(){try{let{data:a,error:r}=yield n.from("citas").insert({fecha_hora:e.fechaHora.toISOString(),duracion_min:e.duracionMin,paciente_id:e.pacienteId,especialista_id:e.especialistaId,especialidad_id:e.especialidadId,estado:e.estado,comentario_paciente:e.comentarioPaciente,comentario_especialista:e.comentarioEspecialista,resenia:e.resenia}).select().maybeSingle();return r||!a?(console.error("Error al insertar cita:",r),{success:!1,message:"No se pudo registrar la cita",errorCode:r?.code??"insert_error"}):{success:!0,data:y(P({},e),{fechaHora:new Date(a.fecha_hora)})}}catch(a){return console.error("Excepci\xF3n en darAltaCita:",a),{success:!1,message:"Ocurri\xF3 un error inesperado",errorCode:"unexpected_error"}}})}obtenerCitasConRegistro(){return c(this,null,function*(){let{data:e,error:a}=yield n.from("vista_citas_enteras").select("*");if(a)throw new Error(`Error al obtener citas: ${a.message}`);if(!e)return[];let{data:r,error:o}=yield n.from("datos_medicos_dinamicos").select("*");if(o)throw new Error(`Error al obtener datos din\xE1micos: ${o.message}`);let t={};for(let s of r||[])s.cita_id&&(t[s.cita_id]||(t[s.cita_id]=[]),t[s.cita_id].push({id:s.id,clave:s.clave,valor:s.valor,citaId:s.cita_id}));return e.map(s=>({citaId:s.cita_id,fechaHora:new Date(s.fecha_hora),duracionMin:s.duracion_min,estado:s.estado,comentarioPaciente:s.comentario_paciente??"",comentarioEspecialista:s.comentario_especialista??"",resenia:s.resenia??"",pacienteId:s.paciente_id,pacienteNombreCompleto:s.paciente_nombre_completo,especialistaId:s.especialista_id,especialistaNombreCompleto:s.especialista_nombre_completo,especialidadId:s.especialidad_id,especialidadNombre:s.especialidad_nombre,alturaCm:Number(s.altura_cm),pesoKg:Number(s.peso_kg),temperaturaC:Number(s.temperatura_c),presionArterial:s.presion_arterial??"",datosDinamicos:t[s.cita_id]||[]}))})}obtenerCitasPaciente(e){return c(this,null,function*(){let{data:a,error:r}=yield n.from("vista_citas_enteras").select("*").eq("paciente_id",e);if(r)throw new Error(`Error al obtener citas: ${r.message}`);if(!a)return[];let{data:o,error:t}=yield n.from("datos_medicos_dinamicos").select("*");if(t)throw new Error(`Error al obtener datos din\xE1micos: ${t.message}`);let s={};for(let i of o||[])i.cita_id&&(s[i.cita_id]||(s[i.cita_id]=[]),s[i.cita_id].push({id:i.id,clave:i.clave,valor:i.valor,citaId:i.cita_id}));return a.map(i=>({citaId:i.cita_id,fechaHora:new Date(i.fecha_hora),duracionMin:i.duracion_min,estado:i.estado,comentarioPaciente:i.comentario_paciente??"",comentarioEspecialista:i.comentario_especialista??"",resenia:i.resenia??"",pacienteId:i.paciente_id,pacienteNombreCompleto:i.paciente_nombre_completo,especialistaId:i.especialista_id,especialistaNombreCompleto:i.especialista_nombre_completo,especialidadId:i.especialidad_id,especialidadNombre:i.especialidad_nombre,alturaCm:Number(i.altura_cm),pesoKg:Number(i.peso_kg),temperaturaC:Number(i.temperatura_c),presionArterial:i.presion_arterial??"",datosDinamicos:s[i.cita_id]||[]}))})}cancelarCitaPaciente(e,a){return c(this,null,function*(){if(e.estado==="completado")return{success:!1,message:"No se puede cancelar un turno ya realizado."};let{error:r}=yield n.from("citas").update({estado:"cancelado",comentario_paciente:a}).eq("id",e.citaId);return r?{success:!1,message:"Ocurri\xF3 un error al cancelar el turno."}:{success:!0,message:"Turno cancelado exitosamente.",data:!0}})}cargarEncuesta(e,a){return c(this,null,function*(){if(e.estado!=="completado")return{success:!1,message:"El turno debe ser realizado para poder cargar encuesta."};if(!e.resenia||e.resenia.trim()==="")return{success:!1,message:"El especialista debe cargar una rese\xF1a antes de poder cargar una encuesta"};let{data:r,error:o}=yield n.from("encuesta").insert({id:e.citaId,pregunta1:a.pregunta1,pregunta2:a.pregunta2,pregunta3:a.pregunta3,nombre:a.nombre,telefono:a.telefono}).select().maybeSingle();return o||!r?{success:!1,message:"No se pudo registrar la encuesta",errorCode:o?.code??"insert_error"}:{success:!0,message:"Encuesta registrada exitosamente.",data:!0}})}cargarComentarioAtencion(e,a){return c(this,null,function*(){if(e.estado!=="completado")return{success:!1,message:"El turno debe ser realizado para poder calificar la atencion."};let{error:r}=yield n.from("citas").update({comentario_paciente:a}).eq("id",e.citaId);return r?{success:!1,message:"No se pudo registrar la calificacion",errorCode:r?.code??"insert_error"}:{success:!0,message:"Antencion calificada exitosamente.",data:!0}})}cancelarCitaEspecialista(e,a){return c(this,null,function*(){if(e.estado==="completado"||e.estado==="aceptado"||e.estado==="rechazado")return{success:!1,message:"No se puede cancelar un turno ya realizado, aceptado o rechazado."};let{error:r}=yield n.from("citas").update({estado:"cancelado",comentario_especialista:a}).eq("id",e.citaId);return r?{success:!1,message:"Ocurri\xF3 un error al cancelar el turno."}:{success:!0,message:"Turno cancelado exitosamente.",data:!0}})}rechazarCitaEspecialista(e,a){return c(this,null,function*(){if(e.estado==="completado"||e.estado==="aceptado"||e.estado==="cancelado")return{success:!1,message:"No se puede rechazar un turno ya realizado, aceptado o cancelado."};let{error:r}=yield n.from("citas").update({estado:"rechazado",comentario_especialista:a}).eq("id",e.citaId);return r?{success:!1,message:"Ocurri\xF3 un error al rechazar el turno."}:{success:!0,message:"Turno rechazado exitosamente.",data:!0}})}aceptarCitaEspecialista(e){return c(this,null,function*(){if(e.estado==="completado"||e.estado==="rechazado"||e.estado==="cancelado")return{success:!1,message:"No se puede aceprtar un turno ya realizado, rechazado o cancelado."};let{error:a}=yield n.from("citas").update({estado:"aceptado"}).eq("id",e.citaId);return a?{success:!1,message:"Ocurri\xF3 un error al aceptar el turno."}:{success:!0,message:"Turno aceptado exitosamente.",data:!0}})}completarCitaEspecialista(e,a){return c(this,null,function*(){if(e.estado!=="aceptado")return{success:!1,message:"No se puede finalizar un turno que no fue aceptado."};let{error:r}=yield n.from("citas").update({estado:"completado",resenia:a}).eq("id",e.citaId);return r?{success:!1,message:"Ocurri\xF3 un error al completar el turno."}:{success:!0,message:"Turno completado exitosamente.",data:!0}})}obtenerCitasEspecialista(e){return c(this,null,function*(){let{data:a,error:r}=yield n.from("vista_citas_enteras").select("*").eq("especialista_id",e);if(r)throw new Error(`Error al obtener citas: ${r.message}`);if(!a)return[];let{data:o,error:t}=yield n.from("datos_medicos_dinamicos").select("*");if(t)throw new Error(`Error al obtener datos din\xE1micos: ${t.message}`);let s={};for(let i of o||[])i.cita_id&&(s[i.cita_id]||(s[i.cita_id]=[]),s[i.cita_id].push({id:i.id,clave:i.clave,valor:i.valor,citaId:i.cita_id}));return a.map(i=>({citaId:i.cita_id,fechaHora:new Date(i.fecha_hora),duracionMin:i.duracion_min,estado:i.estado,comentarioPaciente:i.comentario_paciente??"",comentarioEspecialista:i.comentario_especialista??"",resenia:i.resenia??"",pacienteId:i.paciente_id,pacienteNombreCompleto:i.paciente_nombre_completo,especialistaId:i.especialista_id,especialistaNombreCompleto:i.especialista_nombre_completo,especialidadId:i.especialidad_id,especialidadNombre:i.especialidad_nombre,alturaCm:Number(i.altura_cm),pesoKg:Number(i.peso_kg),temperaturaC:Number(i.temperatura_c),presionArterial:i.presion_arterial??"",datosDinamicos:s[i.cita_id]||[]}))})}cargarHistoriaClinica(e,a){return c(this,null,function*(){if(a.length<1||a.length>6)return{success:!1,message:"Debe cargar entre 1 y 6 datos m\xE9dicos din\xE1micos"};let{error:r}=yield n.from("registros_medicos").insert({cita_id:e.citaId,altura_cm:e.alturaCm,peso_kg:e.pesoKg,temperatura_c:e.temperaturaC,presion_arterial:e.presionArterial});if(r)return{success:!1,message:"Error al guardar los datos principales de la historia cl\xEDnica"};let o=a.map(s=>({cita_id:e.citaId,clave:s.clave,valor:s.valor})),{error:t}=yield n.from("datos_medicos_dinamicos").insert(o);return t?{success:!1,message:"Error al guardar los datos adicionales de la historia cl\xEDnica"}:{success:!0,message:"Historia cl\xEDnica guardada correctamente"}})}obtenerProximosTurnos(e,a=3){let r=new Date;return e.filter(o=>new Date(o.fechaHora)>=r&&o.estado==="aceptado").sort((o,t)=>new Date(o.fechaHora).getTime()-new Date(t.fechaHora).getTime()).slice(0,a)}calcularResumenActividad(e){let a=new Date,r=new Date(a.getFullYear(),a.getMonth(),a.getDate()),o=new Date(r.getTime()+1440*60*1e3),t=new Date(a.getFullYear(),a.getMonth(),1),s=new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59),i=e.filter(l=>new Date(l.fechaHora)>=a&&(l.estado==="solicitado"||l.estado==="aceptado")).length,_=e.filter(l=>{let f=new Date(l.fechaHora);return f>=r&&f<o&&l.estado!=="cancelado"&&l.estado!=="rechazado"}).length,m=e.filter(l=>{let f=new Date(l.fechaHora);return f>=t&&f<=s&&l.estado!=="cancelado"&&l.estado!=="rechazado"}).length,p=e.filter(l=>l.estado==="realizado").sort((l,f)=>new Date(f.fechaHora).getTime()-new Date(l.fechaHora).getTime()),g=p.length>0?new Date(p[0].fechaHora):null;return{turnosPendientes:i,turnosHoy:_,turnosMes:m,ultimaActividad:g}}static \u0275fac=function(a){return new(a||C)};static \u0275prov=v({token:C,factory:C.\u0275fac,providedIn:"root"})};export{N as a};
